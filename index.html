<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<title>Charmers Checkout — Production</title>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<script src='https://js.stripe.com/v3/'></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
body{font-family:Poppins,sans-serif;background:linear-gradient(135deg,#6a00ff,#b300ff);color:#fff;margin:0;padding:20px;}
.container{max-width:700px;margin:auto;background:rgba(255,255,255,0.12);padding:25px;border-radius:14px;}
label{display:block;margin-top:12px;font-size:15px;}
input,select{width:100%;padding:11px;border:none;border-radius:8px;margin-top:5px;}
.section-title{margin-top:25px;font-weight:600;font-size:19px;}
.total-box{margin-top:20px;background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;}
.total-box div{display:flex;justify-content:space-between;margin-bottom:6px;}
#payment-request-button{margin-top:20px;}
#payment-element{background:#fff;color:#000;padding:18px;border-radius:10px;margin-top:25px;}
button{width:100%;padding:16px;font-size:17px;font-weight:600;background:#b300ff;color:#fff;border:none;border-radius:10px;margin-top:20px;}
footer{text-align:center;margin-top:30px;font-size:13px;opacity:0.8;}
</style>
</head>
<body>
<div class='container'>
<h2 style='text-align:center;font-weight:600;'>Charmers Checkout</h2>

<form id='checkout-form'>
<span class='section-title'>Contact Info</span>
<label>Full Name</label><input id='name' required>
<label>Email</label><input id='email' type='email' required>
<label>Phone (optional)</label><input id='phone'>

<span class='section-title'>Bracelet Details</span>
<label>Bracelet Size</label>
<select id='size' required>
<option value=''>Select</option>
<option value='6'>Extra Small – $6</option>
<option value='9'>Small – $9</option>
<option value='11'>Medium – $11</option>
<option value='15'>Large – $15</option>
<option value='20'>Extra Large – $20</option>
</select>

<label>Bracelet Color</label>
<input id='color' required>

<label>Coupon Codes (comma-separated)</label>
<input id='coupon'>

<span class='section-title'>Shipping</span>
<label>Shipping Option</label>
<select id='shipping' required>
<option value='9'>USPS Ground Advantage — $9</option>
<option value='13'>USPS Priority Mail — $13</option>
<option value='25'>USPS Priority Mail Express — $25</option>
<option value='78'>USPS Priority Mail International — $78</option>
<option value='95'>USPS Priority Mail Express International — $95</option>
</select>

<label>Processing</label>
<select id='processing' required>
<option value='0'>CLU Ground Processing — Free</option>
<option value='0.75'>CLU Priority Processing — $0.75</option>
<option value='1.00'>CLU Express Processing — $1.00</option>
</select>

<span class='section-title'>Shipping Address</span>
<label>Country</label>
<select id='country' required>
<option value='US'>United States</option>
<option value='CA'>Canada</option>
<option value='GB'>United Kingdom</option>
<option value='AU'>Australia</option>
<option value='JP'>Japan</option>
<option value='FR'>France</option>
<option value='DE'>Germany</option>
<option value='IN'>India</option>
<option value='BR'>Brazil</option>
<option value='ZA'>South Africa</option>
</select>

<label id='region-label'>State</label>
<input id='region' required>
<label>City</label><input id='city' required>
<label>Street Address</label><input id='address1' required>
<label>Street Address 2 (optional)</label><input id='address2'>
<label>Postal Code</label><input id='postal' required>

<div class='total-box'>
<div><span>Bracelet:</span><span id='braceCost'>$0.00</span></div>
<div><span>Shipping:</span><span id='shipCost'>$0.00</span></div>
<div><span>Processing:</span><span id='procCost'>$0.00</span></div>
<div><span>Coupons:</span><span id='discCost'>$0.00</span></div>
<div><span>Fees:</span><span id='feeCost'>$1.50</span></div>
<div style='border-top:1px solid #fff;padding-top:6px;'><b>Total:</b><b id='total'>$0.00</b></div>
</div>

<label><input type='checkbox' id='tos' required> I agree to the Charmers ToS & policies.</label>

<div id='payment-request-button'></div>
<div id='payment-element'></div>

<button id='pay-btn'>Complete Payment</button>
</form>

<footer>Charmers Checkout © 2025 • All Rights Reserved • Powered by CLU</footer>
</div>

<script>
const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");

const regionMap={US:"State",CA:"Province",GB:"County",AU:"State / Territory",JP:"Prefecture",FR:"Region",DE:"Bundesland",IN:"State",BR:"State",ZA:"Province"};
document.getElementById('country').addEventListener('change',e=>{
 document.getElementById('region-label').textContent=regionMap[e.target.value]||"Region";
});

function applyCoupons(sub){
 let codes=document.getElementById("coupon").value.toUpperCase().split(/[, ]+/).filter(c=>c);
 let d=0;
 const m=new Date().getMonth(),day=new Date().getDate();
 codes.forEach(c=>{
   if(c==="CHARM10BLACKF"&&m===10&&day===28)d+=0.10;
   if(c==="CHRISTMAS35"&&m===11)d+=0.35;
 });
 return {discount:sub*d};
}

function calcTotal(){
 let size=parseFloat(sizeEl.value||0),
     ship=parseFloat(shipEl.value||0),
     proc=parseFloat(procEl.value||0),
     fee=1.5;
 let sub=size+ship+proc+fee;
 let {discount}=applyCoupons(sub);
 let total=sub-discount;
 braceCost.textContent=`$${size.toFixed(2)}`;
 shipCost.textContent=`$${ship.toFixed(2)}`;
 procCost.textContent=`$${proc.toFixed(2)}`;
 discCost.textContent=`-$${discount.toFixed(2)}`;
 totalEl.textContent=`$${total.toFixed(2)}`;
 return Math.round(total*100);
}

const sizeEl=document.getElementById("size");
const shipEl=document.getElementById("shipping");
const procEl=document.getElementById("processing");
const couponEl=document.getElementById("coupon");
const braceCost=document.getElementById("braceCost");
const shipCost=document.getElementById("shipCost");
const procCost=document.getElementById("procCost");
const discCost=document.getElementById("discCost");
const totalEl=document.getElementById("total");
[sizeEl,shipEl,procEl,couponEl].forEach(e=>e.addEventListener("input",calcTotal));
calcTotal();

async function initStripe(){
 const amount = calcTotal();
 let res = await fetch("https://pay-charmersv2.onrender.com/create-payment-intent",{
   method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount})
 });
 let {clientSecret} = await res.json();
 const elements = stripe.elements({clientSecret,appearance:{theme:"night"}});

 const pr = stripe.paymentRequest({
   country:"US",currency:"usd",
   total:{label:"Charmers Order",amount},
   requestPayerName:true,requestPayerEmail:true
 });

 const prButton = elements.create("paymentRequestButton",{paymentRequest:pr});
 pr.canMakePayment().then(r=>{if(r)prButton.mount("#payment-request-button");});

 const paymentElement = elements.create("payment");
 paymentElement.mount("#payment-element");

 document.getElementById("checkout-form").addEventListener("submit",async e=>{
  e.preventDefault();
  if(!document.getElementById("tos").checked)return alert("You must agree to ToS");
  const result = await stripe.confirmPayment({elements,redirect:"if_required"});
  if(result.error){alert(result.error.message);}
  else{alert("Payment successful!");}
 });
}

initStripe();
</script>
</body>
</html>
