<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Charmers Checkout</title>
  <link rel="icon" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..." type="image/jpeg">
  <style>
    :root {
      --bg1: #6a0dad; /* purple */
      --bg2: #ff69b4; /* pink */
      --card: #1f1f1f;
      --text: #ffffff;
      --muted: #cfcfcf;
      --accent: #ff69b4;
      --accent-hover: #ff1493;
      --danger: #ff6b6b;
      --success: #90ee90;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .form-container {
      background: var(--card);
      width: 100%;
      max-width: 640px;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    h1, h2, h3 { margin: 0 0 12px; }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid-1 { grid-template-columns: 1fr; }
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #2a2a2a;
      color: var(--text);
      outline: none;
    }
    input::placeholder { color: #9e9e9e; }
    .row { margin-bottom: 12px; }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    a { color: #ffd1e8; }
    #payment-request-wrap {
      margin: 10px 0 12px;
      display: none; /* toggled by JS */
    }
    #payment-request-button {
      width: 100%;
    }
    .StripeElement, .stripe-hosted {
      background: #2a2a2a;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #333;
    }
    .totals {
      background: #232323;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
      font-size: 14px;
      line-height: 1.5;
    }
    .totals .line {
      display: flex;
      justify-content: space-between;
    }
    .totals .grand {
      margin-top: 8px;
      font-weight: 700;
      font-size: 16px;
    }
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 14px;
      width: 100%;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s ease;
      margin-top: 10px;
    }
    .btn:hover { background: var(--accent-hover); }
    .btn[disabled] {
      opacity: .65;
      cursor: not-allowed;
    }
    #card-errors {
      color: var(--danger);
      min-height: 18px;
      margin-top: 6px;
      font-size: 13px;
    }
    #payment-message {
      text-align: center;
      font-weight: 700;
      margin-top: 10px;
      min-height: 20px;
    }
    #payment-message.success { color: var(--success); }
    #payment-message.fail { color: var(--danger); }
    .footer {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      margin-top: 14px;
    }
  </style>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <!-- reCAPTCHA Enterprise -->
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"></script>
</head>
<body>
  <div class="form-container">
    <h2>Charmers Checkout</h2>
    <div class="subtitle">Secure payment powered by Stripe</div>

    <!-- Apple/Google Pay (Payment Request Button) -->
    <div id="payment-request-wrap">
      <div id="payment-request-button"></div>
    </div>

    <form id="checkoutForm" class="grid grid-1" autocomplete="on">
      <div class="row">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" placeholder="Full name" required>
      </div>
      <div class="row">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>
      </div>
      <div class="row">
        <label for="phone">Phone (optional)</label>
        <input id="phone" name="phone" type="tel" placeholder="(optional)">
      </div>
      <div class="row">
        <label for="bracelet">Bracelet Text</label>
        <input id="bracelet" name="bracelet" type="text" placeholder="Your custom text" required>
      </div>

      <div class="grid">
        <div class="row">
          <label for="shipping">Shipping</label>
          <select id="shipping" name="shipping" required>
            <option value="">Select Shipping</option>
            <option value="9">Ground Advantage - $9</option>
            <option value="13">Priority Mail - $13</option>
            <option value="25">Priority Mail Express - $25</option>
            <option value="47">USPS First Class International - $47</option>
            <option value="78">USPS Priority Mail International - $78</option>
          </select>
        </div>
        <div class="row">
          <label for="processing">Processing</label>
          <select id="processing" name="processing" required>
            <option value="0.50">Charmers 24 Hour Processing™ - $0.50</option>
            <option value="0">Charmers Seven Day 12 Hours Processing™ - $0.00</option>
          </select>
        </div>
      </div>

      <div class="row">
        <label for="street">Street Address</label>
        <input id="street" name="street" type="text" placeholder="Street address" required>
      </div>
      <div class="row">
        <label for="street2">Street Address 2 (optional)</label>
        <input id="street2" name="street2" type="text" placeholder="Apt, suite, etc. (optional)">
      </div>

      <div class="grid">
        <div class="row">
          <label for="city">City</label>
          <input id="city" name="city" type="text" required>
        </div>
        <div class="row">
          <label for="state">State/Territory (optional)</label>
          <input id="state" name="state" type="text">
        </div>
      </div>
      <div class="grid">
        <div class="row">
          <label for="postal">Postal Code</label>
          <input id="postal" name="postal" type="text" required>
        </div>
        <div class="row">
          <label for="country">Country</label>
          <input id="country" name="country" type="text" required>
        </div>
      </div>

      <!-- Card Element -->
      <div class="row">
        <label>Card</label>
        <div id="card-element" class="stripe-hosted"></div>
        <div id="card-errors" role="alert"></div>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="tos" required>
        <label for="tos">I agree to the <a href="https://tos.charmersbiz.org/" target="_blank" rel="noopener">ToS and usage policies</a></label>
      </div>

      <!-- reCAPTCHA placeholder (token grabbed programmatically) -->
      <input type="hidden" id="recaptcha_token" name="recaptcha_token" />

      <div class="totals" id="totalsBox">
        <div class="line"><span>Bracelet</span><span id="priceBracelet">$0.00</span></div>
        <div class="line"><span>Shipping</span><span id="priceShipping">$0.00</span></div>
        <div class="line"><span>Processing</span><span id="priceProcessing">$0.00</span></div>
        <div class="grand"><span>Total</span> <span id="priceTotal">$0.00</span></div>
        <div id="tooLong" style="color: var(--danger); display:none; margin-top:6px;">Bracelet text too long (max 100 chars).</div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Complete Order</button>
      <div id="payment-message"></div>
    </form>

    <div class="footer">
      Powered by Stripe • For refunds, <a href="https://refund.charmersbiz.org/" target="_blank" rel="noopener">click here</a>.
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const STRIPE_PK = "pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc";
    const RECAPTCHA_SITE_KEY = "6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO";
    const BACKEND_BASE = "https://charmerspay.onrender.com"; // update if needed
    // =====================

    const stripe = Stripe(STRIPE_PK);
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    const form = document.getElementById("checkoutForm");
    const submitBtn = document.getElementById("submitBtn");
    const msg = document.getElementById("payment-message");
    const errorBox = document.getElementById("card-errors");
    const prWrap = document.getElementById("payment-request-wrap");
    const prContainer = document.getElementById("payment-request-button");

    let pr;
    let prButton;
    let prSupported = false;
    let prCapabilities = null; // to infer Apple vs Google

    // Map Stripe error codes to friendlier text
    function friendlyError(code, fallback) {
      const map = {
        "card_declined": "The card was declined by your bank, try again later.",
        "incorrect_number": "Check the card number.",
        "expired_card": "Your card has expired.",
        "processing_error": "There was a processing error. Please try again.",
        "insufficient_funds": "The card has insufficient funds.",
      };
      return map[code] || (fallback || "Something went wrong. Please try again.");
    }

    function currency(n) {
      return `$${(Math.round(Number(n) * 100) / 100).toFixed(2)}`;
    }

    function getFields() {
      const data = {};
      new FormData(form).forEach((v, k) => data[k] = v);
      return data;
    }

    function calcPricing() {
      const f = getFields();
      const text = (f.bracelet || "").trim();
      const shipping = parseFloat(f.shipping || 0);
      const processing = parseFloat(f.processing || 0);
      let bracelet = 0;
      let blocked = false;

      if (text.length > 100) blocked = true;
      else if (text.length > 30) bracelet = 15;
      else if (text.length > 12) bracelet = 10;
      else if (text.length >= 6) bracelet = 6;
      else if (text.length > 0) bracelet = 3;

      const total = blocked ? 0 : (bracelet + shipping + processing);
      return { bracelet, shipping, processing, total, blocked };
    }

    function updateTotalsUI() {
      const p = calcPricing();
      document.getElementById("priceBracelet").textContent = currency(p.bracelet);
      document.getElementById("priceShipping").textContent = currency(p.shipping);
      document.getElementById("priceProcessing").textContent = currency(p.processing);
      document.getElementById("priceTotal").textContent = currency(p.total);
      document.getElementById("tooLong").style.display = p.blocked ? "block" : "none";
      // Update PRB total if supported
      if (prSupported && !p.blocked && validForWallet()) {
        pr.update({
          total: { label: "Charmers Order", amount: Math.round(p.total * 100) }
        });
      }
      togglePRB();
    }

    function validForWallet() {
      const f = getFields();
      const required = ["name","email","bracelet","shipping","processing"];
      const filled = required.every(k => (f[k] || "").toString().trim() !== "");
      return filled && !calcPricing().blocked;
    }

    function togglePRB() {
      // Show PRB only if supported and fields are valid
      if (prSupported && validForWallet()) {
        prWrap.style.display = "block";
      } else {
        prWrap.style.display = "none";
      }
    }

    // Initialize Payment Request Button
    function initPaymentRequest() {
      pr = stripe.paymentRequest({
        country: "US",
        currency: "usd",
        total: { label: "Charmers Order", amount: Math.round(calcPricing().total * 100) },
        requestPayerName: true,
        requestPayerEmail: true
      });

      pr.canMakePayment().then(result => {
        if (result) {
          prSupported = true;
          prCapabilities = result; // e.g., {applePay: true} or {googlePay: true}
          prButton = elements.create("paymentRequestButton", { paymentRequest: pr });
          prButton.mount("#payment-request-button");
          togglePRB();
        } else {
          prSupported = false;
          prWrap.style.display = "none";
        }
      });

      pr.on("paymentmethod", async (ev) => {
        // infer wallet type for messaging
        const walletType = (window.ApplePaySession && prCapabilities && prCapabilities.applePay) ? "apple" :
                           (prCapabilities && prCapabilities.googlePay) ? "google" : "wallet";

        try {
          submitBtn.disabled = true;
          setMessage("", "");

          const recaptchaToken = await executeRecaptcha("wallet");
          const pricing = calcPricing();
          if (pricing.blocked || pricing.total <= 0) {
            ev.complete("fail");
            setMessage("fail", "Your payment failed.");
            submitBtn.disabled = false;
            return;
          }

          // Create PaymentIntent on backend
          const res = await fetch(`${BACKEND_BASE}/create-payment-intent`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amount: Math.round(pricing.total * 100),
              currency: "usd",
              recaptcha_token: recaptchaToken,
              metadata: buildMetadata()
            })
          });
          const data = await res.json();
          if (!data || !data.client_secret) throw new Error("Missing client_secret");

          // Confirm without handling next actions (for PRB flow)
          const confirm = await stripe.confirmCardPayment(data.client_secret, {
            payment_method: ev.paymentMethod.id
          }, { handleActions: false });

          if (confirm.error) {
            ev.complete("fail");
            setWalletFailMessage(walletType, confirm.error);
            submitBtn.disabled = false;
            return;
          } else {
            ev.complete("success");
          }

          // If required, handle next actions (3DS, etc.)
          let paymentIntent = confirm.paymentIntent;
          if (paymentIntent && paymentIntent.status === "requires_action") {
            const next = await stripe.confirmCardPayment(data.client_secret);
            if (next.error) {
              setWalletFailMessage(walletType, next.error);
              submitBtn.disabled = false;
              return;
            }
            paymentIntent = next.paymentIntent;
          }

          // Success
          await sendOrderToBackend(paymentIntent && paymentIntent.id, walletType);
          setWalletSuccessMessage(walletType);
          submitBtn.disabled = false;
        } catch (err) {
          console.error(err);
          ev.complete && ev.complete("fail");
          setMessage("fail", "Your payment failed.");
          submitBtn.disabled = false;
        }
      });
    }

    function buildMetadata() {
      const f = getFields();
      const p = calcPricing();
      return {
        name: f.name || "",
        email: f.email || "",
        phone: f.phone || "",
        bracelet: f.bracelet || "",
        shipping: f.shipping || "",
        processing: f.processing || "",
        street: f.street || "",
        street2: f.street2 || "",
        city: f.city || "",
        state: f.state || "",
        postal: f.postal || "",
        country: f.country || "",
        total_display: currency(p.total)
      };
    }

    function setMessage(kind, text) {
      msg.classList.remove("success","fail");
      if (!text) { msg.textContent = ""; return; }
      msg.classList.add(kind === "success" ? "success" : "fail");
      msg.textContent = text;
    }

    function setWalletSuccessMessage(walletType) {
      // Specific + unified success
      const specific = walletType === "apple"
        ? "Payment processed. Confirmation email coming soon."
        : walletType === "google"
          ? "Confirmation email sent."
          : "Payment processed.";
      const unified = "Your order was processed. Expect a confirmation email from Charmers soon.";
      setMessage("success", `${specific} ${unified}`);
    }
    function setWalletFailMessage(walletType, err) {
      // Specific + unified failure
      const specific = walletType === "apple"
        ? "Payment failed. Try card number payment."
        : walletType === "google"
          ? "Payment failed. Try card number."
          : friendlyError(err && err.code, "Your payment failed.");
      const unified = "Your payment failed.";
      setMessage("fail", `${specific} ${unified}`);
    }

    function executeRecaptcha(action) {
      return new Promise((resolve, reject) => {
        if (!window.grecaptcha || !grecaptcha.enterprise) {
          return resolve(""); // fail-open so checkout can still work
        }
        grecaptcha.enterprise.ready(() => {
          grecaptcha.enterprise.execute(RECAPTCHA_SITE_KEY, { action })
            .then(token => {
              document.getElementById("recaptcha_token").value = token;
              resolve(token);
            })
            .catch(() => resolve(""));
        });
      });
    }

    async function sendOrderToBackend(payment_intent_id, methodUsed) {
      const f = getFields();
      const p = calcPricing();
      try {
        await fetch(`${BACKEND_BASE}/save-order`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            payment_intent_id,
            method: methodUsed || "card",
            total_cents: Math.round(p.total * 100),
            order: {
              ...f,
              total_display: currency(p.total),
            }
          })
        });
      } catch (e) {
        console.warn("Order save failed (non-blocking)", e);
      }
    }

    // Card Element errors
    card.on("change", function (event) {
      errorBox.textContent = event.error ? friendlyError(event.error.code, event.error.message) : "";
    });

    // Form submit for card payments
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage("", "");
      errorBox.textContent = "";

      const p = calcPricing();
      if (p.blocked) {
        setMessage("fail", "Bracelet text too long (max 100 chars).");
        return;
      }
      if (p.total <= 0) {
        setMessage("fail", "Please complete all required fields.");
        return;
      }
      if (!document.getElementById("tos").checked) {
        setMessage("fail", "Please agree to the ToS to continue.");
        return;
      }

      try {
        submitBtn.disabled = true;
        const token = await executeRecaptcha("card");
        // Create PaymentIntent
        const res = await fetch(`${BACKEND_BASE}/create-payment-intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: Math.round(p.total * 100),
            currency: "usd",
            recaptcha_token: token,
            metadata: buildMetadata()
          })
        });
        const data = await res.json();
        if (!data || !data.client_secret) throw new Error("Missing client_secret");

        // Confirm
        const confirm = await stripe.confirmCardPayment(data.client_secret, {
          payment_method: {
            card,
            billing_details: {
              name: document.getElementById("name").value,
              email: document.getElementById("email").value,
            }
          }
        });

        if (confirm.error) {
          errorBox.textContent = friendlyError(confirm.error.code, confirm.error.message);
          setMessage("fail", "Your transaction was failed. Try again later.");
          submitBtn.disabled = false;
          return;
        }

        if (confirm.paymentIntent && confirm.paymentIntent.status === "succeeded") {
          await sendOrderToBackend(confirm.paymentIntent.id, "card");
          // Specific + unified success for card
          setMessage("success", "Your order was processed! Your order was processed. Expect a confirmation email from Charmers soon.");
        } else {
          setMessage("fail", "Your payment failed.");
        }
      } catch (err) {
        console.error(err);
        setMessage("fail", "Your payment failed.");
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Wire up inputs
    Array.from(form.querySelectorAll("input, select")).forEach(el => {
      el.addEventListener("input", updateTotalsUI);
      el.addEventListener("change", updateTotalsUI);
    });

    // Init
    updateTotalsUI();
    initPaymentRequest();
  </script>
</body>
</html>
