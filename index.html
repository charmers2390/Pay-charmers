<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Charmers Bracelets - Handmade custom bracelets">
    <title>Charmers Bracelets</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        /* Additional photo-specific styles */
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .product-image.has-photo img {
            display: block;
        }
        
        .product-image.has-photo .no-photo {
            display: none;
        }
        
        .photo-credit {
            font-size: 0.7rem;
            color: #999;
            text-align: center;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Charmers Bracelets</h1>
    </header>

    <div class="banner">
        We're on eBay! <a href="https://ebay.us/m/S51i6y" target="_blank" rel="noopener">Visit our store</a>
    </div>

    <main>
        <!-- Checkout Flow -->
        <div class="checkout-flow">
            <!-- Progress Indicator -->
            <div class="flow-indicator">
                <div class="flow-dot active" id="dot-1"></div>
                <div class="flow-dot" id="dot-2"></div>
                <div class="flow-dot" id="dot-3"></div>
                <div class="flow-dot" id="dot-4"></div>
            </div>
            
            <!-- Step 1: Product Selection -->
            <div id="step-1" class="flow-step active">
                <h2 class="flow-title">Choose Your Bracelet</h2>
                
                <div class="product-gallery">
                    <!-- Birthstone Bracelet -->
                    <div class="product-card" data-product="birthstone">
                        <div class="product-image has-photo">
                            <img src="https://images.unsplash.com/photo-1605100804763-247f67b3557e?w=400&h=300&fit=crop&auto=format" 
                                 alt="Birthstone bracelet with colorful gemstones"
                                 loading="lazy"
                                 onerror="this.style.display='none'; this.parentElement.classList.remove('has-photo')">
                            <div class="no-photo">
                                <div style="font-size: 48px; margin-bottom: 12px;">💎</div>
                                <strong>Birthstone Bracelet</strong>
                            </div>
                        </div>
                        <div class="photo-credit">Photo: Unsplash</div>
                        <div class="product-info">
                            <h3 class="product-title">Charmers Birthstone Series</h3>
                            <p class="product-price">Starting at $5</p>
                            <p class="product-description">Personalized birthstone bracelet. 10% of profits donated to Montessori School of Franklin.</p>
                            <button class="btn" onclick="selectProduct('birthstone')">Select This Bracelet</button>
                        </div>
                    </div>
                    
                    <!-- Heart Bracelet -->
                    <div class="product-card" data-product="heart">
                        <div class="product-image has-photo">
                            <img src="https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?w=400&h=300&fit=crop&auto=format" 
                                 alt="Heart-shaped pink and purple bracelet"
                                 loading="lazy"
                                 onerror="this.style.display='none'; this.parentElement.classList.remove('has-photo')">
                            <div class="no-photo">
                                <div style="font-size: 48px; margin-bottom: 12px;">💖</div>
                                <strong>Heart Bracelet</strong>
                            </div>
                        </div>
                        <div class="photo-credit">Photo: Unsplash</div>
                        <div class="product-info">
                            <h3 class="product-title">Charmers Heart Bracelet</h3>
                            <p class="product-price">Starting at $5</p>
                            <p class="product-description">Beautiful pink & purple heart design. Perfect for any occasion.</p>
                            <button class="btn" onclick="selectProduct('heart')">Select This Bracelet</button>
                        </div>
                    </div>
                    
                    <!-- Custom Bracelet -->
                    <div class="product-card" data-product="custom">
                        <div class="product-image has-photo">
                            <img src="https://images.unsplash.com/photo-1620234901387-5b4caa6a1749?w=400&h=300&fit=crop&auto=format" 
                                 alt="Customizable bracelet with colorful beads"
                                 loading="lazy"
                                 onerror="this.style.display='none'; this.parentElement.classList.remove('has-photo')">
                            <div class="no-photo">
                                <div style="font-size: 48px; margin-bottom: 12px;">🎨</div>
                                <strong>Custom Bracelet</strong>
                            </div>
                        </div>
                        <div class="photo-credit">Photo: Unsplash</div>
                        <div class="product-info">
                            <h3 class="product-title">Create Your Own Bracelet</h3>
                            <p class="product-price">Starting at $5</p>
                            <p class="product-description">Design your own unique bracelet. Choose colors, theme, and more!</p>
                            <button class="btn" onclick="selectProduct('custom')">Create Custom Bracelet</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Customization -->
            <div id="step-2" class="flow-step">
                <h2 class="flow-title">Customize Your <span id="product-name">Bracelet</span></h2>
                
                <div class="product-summary">
                    <h3>Selected: <span id="selected-product-name">Birthstone Bracelet</span></h3>
                </div>
                
                <!-- Birthstone customization -->
                <div id="birthstone-customization" class="bracelet-customization hidden">
                    <label for="birthstone-input">Your birthstone month <span class="required">*</span></label>
                    <input id="birthstone-input" type="text" placeholder="e.g., April, May, Emerald" required>
                    
                    <label>Select size <span class="required">*</span></label>
                    <div class="size-options">
                        <div class="size-option" data-size="small" data-price="5">
                            Small<br>
                            <span class="size-price">$5</span>
                        </div>
                        <div class="size-option" data-size="medium" data-price="9">
                            Medium<br>
                            <span class="size-price">$9</span>
                        </div>
                        <div class="size-option" data-size="large" data-price="11">
                            Large<br>
                            <span class="size-price">$11</span>
                        </div>
                        <div class="size-option" data-size="xlarge" data-price="15">
                            X-Large<br>
                            <span class="size-price">$15</span>
                        </div>
                    </div>
                    
                    <label for="birthstone-personalization">Personalization text (optional)</label>
                    <textarea id="birthstone-personalization" rows="3" placeholder="Add a special message or name"></textarea>
                </div>
                
                <!-- Heart customization -->
                <div id="heart-customization" class="bracelet-customization hidden">
                    <p style="color: #666; font-style: italic;">Colors fixed to pink & purple.</p>
                    
                    <label>Select size <span class="required">*</span></label>
                    <div class="size-options">
                        <div class="size-option" data-size="small" data-price="5">
                            Small<br>
                            <span class="size-price">$5</span>
                        </div>
                        <div class="size-option" data-size="medium" data-price="9">
                            Medium<br>
                            <span class="size-price">$9</span>
                        </div>
                        <div class="size-option" data-size="large" data-price="11">
                            Large<br>
                            <span class="size-price">$11</span>
                        </div>
                        <div class="size-option" data-size="xlarge" data-price="15">
                            X-Large<br>
                            <span class="size-price">$15</span>
                        </div>
                    </div>
                    
                    <label for="heart-personalization">Personalization text (optional)</label>
                    <textarea id="heart-personalization" rows="3" placeholder="Add a special message or name"></textarea>
                </div>
                
                <!-- Custom bracelet customization -->
                <div id="custom-customization" class="bracelet-customization hidden">
                    <label for="custom-feature">What do you want it to feature? <span class="required">*</span></label>
                    <input id="custom-feature" type="text" placeholder="Describe your design or theme" required>
                    
                    <label for="custom-color">Primary color</label>
                    <select id="custom-color">
                        <option value="">Select a color</option>
                        <option value="red">Red</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                    </select>
                    
                    <label for="custom-color-custom">Or enter custom color</label>
                    <input id="custom-color-custom" type="text" placeholder="Custom color name">
                    
                    <label for="custom-color2">Optional second color</label>
                    <select id="custom-color2">
                        <option value="">Select a color (optional)</option>
                        <option value="red">Red</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                    </select>
                    
                    <label>Select size <span class="required">*</span></label>
                    <div class="size-options">
                        <div class="size-option" data-size="small" data-price="5">
                            Small<br>
                            <span class="size-price">$5</span>
                        </div>
                        <div class="size-option" data-size="medium" data-price="9">
                            Medium<br>
                            <span class="size-price">$9</span>
                        </div>
                        <div class="size-option" data-size="large" data-price="11">
                            Large<br>
                            <span class="size-price">$11</span>
                        </div>
                        <div class="size-option" data-size="xlarge" data-price="15">
                            X-Large<br>
                            <span class="size-price">$15</span>
                        </div>
                    </div>
                    
                    <label for="donation">Donate to (optional)</label>
                    <select id="donation">
                        <option value="remove_co2">Remove CO₂ from our environment</option>
                        <option value="msf">Montessori School of Franklin</option>
                        <option value="none">No donation</option>
                    </select>
                    
                    <label for="custom-personalization">Personalization text (optional)</label>
                    <textarea id="custom-personalization" rows="3" placeholder="Add a special message or name"></textarea>
                </div>
                
                <div class="flow-navigation">
                    <button class="btn secondary" onclick="goToStep(1)">← Back</button>
                    <button class="btn" onclick="goToStep(3)">Continue to Shipping →</button>
                </div>
            </div>
            
            <!-- Step 3: Shipping -->
            <div id="step-3" class="flow-step">
                <h2 class="flow-title">Shipping Information</h2>
                
                <div class="product-summary" id="order-summary">
                    <!-- Order summary will be populated here -->
                </div>
                
                <div class="section">
                    <label for="shipping-option">Shipping method <span class="required">*</span></label>
                    <select id="shipping-option" required>
                        <option value="">Select shipping</option>
                        <!-- Domestic Shipping -->
                        <optgroup label="US Domestic">
                            <option value="usps_ground" data-price="9">USPS Ground Advantage — $9 (3-5 business days)</option>
                            <option value="usps_priority" data-price="11">USPS Priority Mail — $11 (1-3 business days)</option>
                            <option value="usps_express" data-price="29">USPS Priority Mail Express — $29 (1-2 business days)</option>
                        </optgroup>
                        <!-- International Shipping -->
                        <optgroup label="International (Select if shipping outside US)">
                            <option value="usps_intl_pri" data-price="28">USPS Priority Mail International — $28 (6-10 business days)</option>
                            <option value="usps_intl_exp" data-price="45">USPS Priority Mail Express International — $45 (3-5 business days)</option>
                            <option value="ups_worldwide_saver" data-price="65">UPS Worldwide Saver — $65 (1-3 business days)</option>
                            <option value="ups_worldwide_expedited" data-price="93">UPS Worldwide Expedited — $93 (2-5 business days)</option>
                            <option value="ups_worldwide_express" data-price="119">UPS Worldwide Express — $119 (1-3 business days)</option>
                        </optgroup>
                    </select>
                    
                    <h3 style="margin-top: 24px;">Shipping Address</h3>
                    
                    <label for="name">Full name <span class="required">*</span></label>
                    <input id="name" type="text" placeholder="Your full name" required>
                    
                    <label for="email">Email address <span class="required">*</span></label>
                    <input id="email" type="email" placeholder="you@example.com" required>
                    
                    <label for="phone">Phone number (optional)</label>
                    <input id="phone" type="tel" placeholder="(123) 456-7890">
                    
                    <label for="address1">Street address <span class="required">*</span></label>
                    <input id="address1" type="text" placeholder="123 Main St" required>
                    
                    <label for="address2">Apartment, suite, etc. (optional)</label>
                    <input id="address2" type="text" placeholder="Apt 4B">
                    
                    <div class="inline-group">
                        <div>
                            <label for="city">City <span class="required">*</span></label>
                            <input id="city" type="text" placeholder="City" required>
                        </div>
                        <div>
                            <label for="state">State / Province <span class="required">*</span></label>
                            <input id="state" type="text" placeholder="State" required>
                        </div>
                    </div>
                    
                    <div class="inline-group">
                        <div>
                            <label for="postal">ZIP / Postal code <span class="required">*</span></label>
                            <input id="postal" type="text" placeholder="12345" required>
                        </div>
                        <div>
                            <label for="country">Country <span class="required">*</span></label>
                            <select id="country" required>
                                <option value="">Select country</option>
                                <option value="US">United States</option>
                                <option value="CA">Canada</option>
                                <option value="GB">United Kingdom</option>
                                <option value="AU">Australia</option>
                                <option value="DE">Germany</option>
                                <option value="FR">France</option>
                                <option value="JP">Japan</option>
                                <option value="OTHER">Other Country</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="flow-navigation">
                    <button class="btn secondary" onclick="goToStep(2)">← Back</button>
                    <button class="btn" onclick="goToStep(4)">Continue to Payment →</button>
                </div>
            </div>
            
            <!-- Step 4: Payment -->
            <div id="step-4" class="flow-step">
                <h2 class="flow-title">Payment</h2>
                
                <div class="section">
                    <div id="payment-request-button" class="hidden"></div>
                    
                    <div id="card-element" style="margin-top:16px;"></div>
                    
                    <div id="card-errors" role="alert"></div>
                    
                    <button id="card-button" class="btn" style="width: 100%; margin-top: 20px;">Pay Now</button>
                </div>
                
                <div class="flow-navigation">
                    <button class="btn secondary" onclick="goToStep(3)">← Back to Shipping</button>
                </div>
            </div>
            
            <!-- Success Step -->
            <div id="step-success" class="flow-step">
                <div style="text-align: center; padding: 40px 20px;">
                    <h2 style="color: #5a17ff;">🎉 Order Successful!</h2>
                    <p>Your payment was successful and your order has been saved to our system.</p>
                    <p>Expect a confirmation email from Charmers soon.</p>
                </div>
            </div>
        </div>
        
        <!-- Cart Summary -->
        <div class="cart-summary" id="cart-summary">
            <div class="cart-item">
                <span id="cart-product-name">No product selected</span>
                <span id="cart-product-price">$0.00</span>
            </div>
            <div class="cart-item">
                <span>Shipping</span>
                <span id="cart-shipping-price">$0.00</span>
            </div>
            <div class="cart-item">
                <strong>Total</strong>
                <strong id="cart-total-price">$0.00</strong>
            </div>
            <button id="checkout-btn" class="btn" style="width: 100%; margin-top: 16px;">Proceed to Checkout</button>
        </div>
    </main>

    <script>
    // Configuration
    const BACKEND_URL = 'https://literate-tribble-fm5n.onrender.com';
    const stripePublicKey = 'pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc';
    
    const paymentIntentUrl = `${BACKEND_URL}/create-payment-intent`;
    const saveOrderUrl = `${BACKEND_URL}/save-order`;

    // State
    let selectedProduct = null;
    let selectedSize = null;
    let braceletPrice = 0;
    let shippingPrice = 0;
    let stripe = null;
    let elements = null;
    let card = null;
    let paymentRequest = null;

    // Product data
    const products = {
        birthstone: {
            name: 'Birthstone Bracelet',
            basePrice: 5,
            customization: 'birthstone'
        },
        heart: {
            name: 'Heart Bracelet',
            basePrice: 5,
            customization: 'heart'
        },
        custom: {
            name: 'Custom Bracelet',
            basePrice: 5,
            customization: 'custom'
        }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initStripe();
        updateCartSummary();
    });

    function initStripe() {
        stripe = Stripe(stripePublicKey);
        elements = stripe.elements();
        
        const style = {
            base: {
                color: "#32325d",
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                fontSmoothing: "antialiased",
                fontSize: "16px",
                "::placeholder": { color: "#a0a0a0" }
            },
            invalid: { color: "#d32f2f", iconColor: "#d32f2f" }
        };
        
        card = elements.create("card", {style: style});
        card.mount("#card-element");
        
        card.on('change', (event) => {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        
        initPaymentRequestButton();
    }

    function initPaymentRequestButton() {
        paymentRequest = stripe.paymentRequest({
            country: 'US',
            currency: 'usd',
            total: {
                label: 'Charmers Bracelet',
                amount: 0,
            },
            requestPayerName: true,
            requestPayerEmail: true,
            requestPayerPhone: true,
            requestShipping: true,
            shippingOptions: [
                {
                    id: 'usps_ground',
                    label: 'USPS Ground Advantage',
                    detail: '3-5 business days',
                    amount: 900,
                },
                {
                    id: 'usps_priority',
                    label: 'USPS Priority Mail',
                    detail: '1-3 business days',
                    amount: 1100,
                },
                {
                    id: 'usps_express',
                    label: 'USPS Priority Mail Express',
                    detail: '1-2 business days',
                    amount: 2900,
                },
                {
                    id: 'usps_intl_pri',
                    label: 'USPS Priority Mail International',
                    detail: '6-10 business days',
                    amount: 2800,
                },
                {
                    id: 'usps_intl_exp',
                    label: 'USPS Priority Mail Express International',
                    detail: '3-5 business days',
                    amount: 4500,
                }
            ]
        });

        const prButton = elements.create('paymentRequestButton', {
            paymentRequest,
            style: {
                paymentRequestButton: {
                    theme: 'dark',
                    height: '44px',
                }
            }
        });

        paymentRequest.canMakePayment().then(result => {
            if (result) {
                document.getElementById('payment-request-button').classList.remove('hidden');
                prButton.mount('#payment-request-button');
                
                paymentRequest.on('paymentmethod', async ev => {
                    try {
                        // ✅ Validate before doing anything
                        if (!validateShippingForm() || !validateCustomization()) {
                            ev.complete('fail');
                            return;
                        }

                        const orderData = prepareOrderData();
                        const amountCents = Math.round(orderData.total * 100);

                        // ✅ Create PaymentIntent on backend
                        const res = await fetch(paymentIntentUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                amount: amountCents,
                                currency: 'usd',
                                orderDetails: orderData.orderDetails,
                                customerInfo: orderData.customerInfo,
                                shipping: orderData.shipping
                            })
                        });

                        const pi = await res.json();
                        if (pi.error || !pi.clientSecret) {
                            ev.complete('fail');
                            return;
                        }

                        // ✅ Confirm payment (NO updateWith here)
                        const { error, paymentIntent } = await stripe.confirmCardPayment(
                            pi.clientSecret,
                            {
                                payment_method: ev.paymentMethod.id
                            },
                            { handleActions: false }
                        );

                        if (error) {
                            ev.complete('fail');
                            return;
                        }

                        // ✅ Handle required actions (3DS, etc.)
                        if (paymentIntent.status === 'requires_action') {
                            const { error: actionError, paymentIntent: finalIntent } =
                                await stripe.confirmCardPayment(pi.clientSecret);

                            if (actionError) {
                                ev.complete('fail');
                                return;
                            }

                            await saveOrderToBackend(finalIntent.id, orderData);
                        } else {
                            await saveOrderToBackend(paymentIntent.id, orderData);
                        }

                        // ✅ Tell Apple Pay / Google Pay we're done
                        ev.complete('success');
                        showSuccess();

                    } catch (err) {
                        console.error(err);
                        ev.complete('fail');
                    }
                });
            }
        });
    }

    // Product selection
    function selectProduct(productType) {
        selectedProduct = productType;
        
        // Update UI
        document.querySelectorAll('.product-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-product="${productType}"]`).classList.add('selected');
        
        document.querySelectorAll('.btn').forEach(btn => {
            if (btn.textContent.includes('Select') || btn.textContent.includes('Create')) {
                btn.textContent = btn.textContent.replace('✓ ', '');
                btn.classList.remove('selected');
            }
        });
        event.target.textContent = '✓ ' + event.target.textContent;
        event.target.classList.add('selected');
        
        // Show cart summary
        document.getElementById('cart-summary').classList.add('show');
        
        // Update product name in next step
        document.getElementById('product-name').textContent = products[productType].name;
        document.getElementById('selected-product-name').textContent = products[productType].name;
        
        // Update cart
        updateCartSummary();
        
        // Enable checkout button
        document.getElementById('checkout-btn').disabled = false;
    }

    function updateCartSummary() {
        const cartProductName = document.getElementById('cart-product-name');
        const cartProductPrice = document.getElementById('cart-product-price');
        const cartShippingPrice = document.getElementById('cart-shipping-price');
        const cartTotalPrice = document.getElementById('cart-total-price');
        
        if (selectedProduct) {
            cartProductName.textContent = products[selectedProduct].name;
            cartProductPrice.textContent = `$${braceletPrice.toFixed(2)}`;
        } else {
            cartProductName.textContent = 'No product selected';
            cartProductPrice.textContent = '$0.00';
        }
        
        cartShippingPrice.textContent = `$${shippingPrice.toFixed(2)}`;
        
        const total = braceletPrice + shippingPrice;
        cartTotalPrice.textContent = `$${total.toFixed(2)}`;
        
        // Update checkout button text
        document.getElementById('checkout-btn').textContent = `Checkout - $${total.toFixed(2)}`;
    }

    // Flow navigation
    let currentStep = 1;

    function goToStep(step) {
        // Validate current step before proceeding
        if (step > currentStep) {
            if (currentStep === 1 && !selectedProduct) {
                alert('Please select a bracelet first.');
                return;
            }
            if (currentStep === 2 && !validateCustomization()) {
                alert('Please complete all required customization options.');
                return;
            }
            if (currentStep === 3 && !validateShippingForm()) {
                alert('Please complete all required shipping information.');
                return;
            }
        }
        
        // Hide all steps
        document.querySelectorAll('.flow-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Update dots
        document.querySelectorAll('.flow-dot').forEach((dot, index) => {
            dot.classList.remove('active');
            if (index < step) {
                dot.classList.add('active');
            }
        });
        
        // Show target step
        document.getElementById(`step-${step}`).classList.add('active');
        currentStep = step;
        
        // Special handling for step 2
        if (step === 2 && selectedProduct) {
            showCustomization(selectedProduct);
            updateOrderSummary();
        }
        
        // Special handling for step 4
        if (step === 4) {
            updateOrderSummary();
        }
    }

    // Checkout button
    document.getElementById('checkout-btn').addEventListener('click', function() {
        if (!selectedProduct) {
            alert('Please select a bracelet first.');
            return;
        }
        goToStep(2);
    });

    // Size selection
    document.addEventListener('click', function(e) {
        if (e.target.closest('.size-option')) {
            const sizeOption = e.target.closest('.size-option');
            
            // Remove selected from all sizes
            document.querySelectorAll('.size-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected to clicked size
            sizeOption.classList.add('selected');
            
            // Update price
            selectedSize = sizeOption.dataset.size;
            braceletPrice = parseFloat(sizeOption.dataset.price);
            
            updateCartSummary();
            updateOrderSummary();
        }
    });

    function showCustomization(productType) {
        // Hide all customizations
        document.querySelectorAll('.bracelet-customization').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Show selected customization
        const customizationId = `${products[productType].customization}-customization`;
        document.getElementById(customizationId).classList.remove('hidden');
        
        // Reset size selection
        document.querySelectorAll('.size-option').forEach(option => {
            option.classList.remove('selected');
        });
        selectedSize = null;
        braceletPrice = products[productType].basePrice;
        
        updateCartSummary();
    }

    function validateCustomization() {
        if (!selectedSize) {
            alert('Please select a size.');
            return false;
        }
        
        if (selectedProduct === 'birthstone') {
            const birthstone = document.getElementById('birthstone-input').value.trim();
            if (!birthstone) {
                alert('Please enter your birthstone month.');
                document.getElementById('birthstone-input').focus();
                return false;
            }
        }
        
        if (selectedProduct === 'custom') {
            const feature = document.getElementById('custom-feature').value.trim();
            if (!feature) {
                alert('Please describe what you want your bracelet to feature.');
                document.getElementById('custom-feature').focus();
                return false;
            }
        }
        
        return true;
    }

    function validateShippingForm() {
        const requiredFields = ['name', 'email', 'address1', 'city', 'state', 'postal', 'country', 'shipping-option'];
        
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                alert(`Please fill in ${field.placeholder || fieldId}`);
                field.focus();
                return false;
            }
        }
        
        // Validate email format
        const email = document.getElementById('email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Please enter a valid email address.');
            document.getElementById('email').focus();
            return false;
        }
        
        // Update shipping price
        updateShippingPrice();
        updateCartSummary();
        
        return true;
    }

    function updateShippingPrice() {
        const shippingOption = document.getElementById('shipping-option');
        const selectedOption = shippingOption.options[shippingOption.selectedIndex];
        shippingPrice = parseFloat(selectedOption.dataset.price) || 0;
    }

    function updateOrderSummary() {
        const summaryDiv = document.getElementById('order-summary');
        let summaryHTML = `<h3>Order Summary</h3>`;
        
        if (selectedProduct) {
            summaryHTML += `
                <p><strong>Product:</strong> ${products[selectedProduct].name}</p>
                <p><strong>Size:</strong> ${selectedSize ? selectedSize.charAt(0).toUpperCase() + selectedSize.slice(1) : 'Not selected'}</p>
            `;
            
            if (selectedProduct === 'birthstone') {
                const birthstone = document.getElementById('birthstone-input').value;
                if (birthstone) summaryHTML += `<p><strong>Birthstone:</strong> ${birthstone}</p>`;
            }
            
            if (selectedProduct === 'custom') {
                const feature = document.getElementById('custom-feature').value;
                if (feature) summaryHTML += `<p><strong>Feature:</strong> ${feature}</p>`;
            }
            
            summaryHTML += `
                <p><strong>Bracelet Price:</strong> $${braceletPrice.toFixed(2)}</p>
                <p><strong>Shipping:</strong> $${shippingPrice.toFixed(2)}</p>
                <p style="font-size: 1.2rem; color: #5a17ff; margin-top: 10px;">
                    <strong>Total: $${(braceletPrice + shippingPrice).toFixed(2)}</strong>
                </p>
            `;
        } else {
            summaryHTML += `<p>No product selected</p>`;
        }
        
        summaryDiv.innerHTML = summaryHTML;
    }

    function prepareOrderData() {
        const total = braceletPrice + shippingPrice;
        const type = selectedProduct;
        
        const orderDetails = {
            braceletType: type,
            total: total,
            size: selectedSize
        };

        // Add product-specific details
        if (type === 'birthstone') {
            orderDetails.birthstone = document.getElementById('birthstone-input').value;
            orderDetails.personalization = document.getElementById('birthstone-personalization').value;
        } else if (type === 'heart') {
            orderDetails.personalization = document.getElementById('heart-personalization').value;
        } else {
            orderDetails.feature = document.getElementById('custom-feature').value;
            orderDetails.color = document.getElementById('custom-color').value || 
                                document.getElementById('custom-color-custom').value;
            orderDetails.color2 = document.getElementById('custom-color2').value;
            orderDetails.donation = document.getElementById('donation').value;
            orderDetails.personalization = document.getElementById('custom-personalization').value;
        }

        const customerInfo = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value || ''
        };

        const shipping = {
            address1: document.getElementById('address1').value,
            address2: document.getElementById('address2').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            postal: document.getElementById('postal').value,
            country: document.getElementById('country').value,
            shippingOption: document.getElementById('shipping-option').value
        };

        return {
            total: total,
            orderDetails,
            customerInfo,
            shipping
        };
    }

    async function saveOrderToBackend(paymentIntentId, orderData) {
        try {
            const response = await fetch(saveOrderUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paymentIntentId: paymentIntentId,
                    status: 'completed',
                    customerInfo: orderData.customerInfo,
                    orderDetails: orderData.orderDetails,
                    shipping: orderData.shipping,
                    amount: orderData.total
                })
            });
            
            const result = await response.json();
            if (result.success) {
                console.log('✅ Order saved to backend');
                localStorage.setItem('hasOrdered','yes');
            }
            return result;
        } catch (error) {
            console.error('Failed to save order:', error);
            return { success: false };
        }
    }

    // Card payment handler
    document.getElementById('card-button').addEventListener('click', async function(e) {
        e.preventDefault();

        if (!validateShippingForm() || !validateCustomization()) {
            return;
        }

        this.disabled = true;
        this.textContent = 'Processing...';

        const orderData = prepareOrderData();
        const amountCents = Math.round(orderData.total * 100);

        // Create PaymentIntent
        let piResponse;
        try {
            piResponse = await fetch(paymentIntentUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: amountCents,
                    currency: 'usd',
                    orderDetails: orderData.orderDetails,
                    customerInfo: orderData.customerInfo,
                    shipping: orderData.shipping
                })
            });
        } catch (err) {
            document.getElementById('card-errors').textContent = 'Error contacting payment server.';
            this.disabled = false;
            this.textContent = 'Pay Now';
            return;
        }

        const pi = await piResponse.json();
        if (pi.error) {
            document.getElementById('card-errors').textContent = pi.error;
            this.disabled = false;
            this.textContent = 'Pay Now';
            return;
        }

        // Confirm card payment
        const { error, paymentIntent } = await stripe.confirmCardPayment(pi.clientSecret, {
            payment_method: {
                card: card,
                billing_details: {
                    name: orderData.customerInfo.name,
                    email: orderData.customerInfo.email,
                    phone: orderData.customerInfo.phone,
                    address: {
                        line1: orderData.shipping.address1,
                        line2: orderData.shipping.address2,
                        city: orderData.shipping.city,
                        state: orderData.shipping.state,
                        postal_code: orderData.shipping.postal,
                        country: orderData.shipping.country
                    }
                }
            }
        });

        if (error) {
            let msg = error.message || 'Payment failed. Please try again.';
            
            if (error.code === 'card_declined' && error.decline_code === 'insufficient_funds') {
                msg = 'The card was declined by your bank, try again later (code: insufficient_funds).';
            } else if (error.code === 'invalid_number' || error.code === 'incorrect_number') {
                msg = 'Check the card number (code: ' + error.code + ').';
            } else if (error.code === 'expired_card') {
                msg = 'Your card has expired. Please use a different card.';
            } else if (error.code === 'incorrect_cvc') {
                msg = 'The CVC number is incorrect. Please check and try again.';
            }
            
            document.getElementById('card-errors').textContent = msg;
            this.disabled = false;
            this.textContent = 'Pay Now';
        } else if (paymentIntent.status === 'succeeded') {
            await saveOrderToBackend(paymentIntent.id, orderData);
            showSuccess();
        }
    });

    function showSuccess() {
        document.querySelectorAll('.flow-step').forEach(step => {
            step.classList.remove('active');
        });
        document.getElementById('step-success').classList.add('active');
        document.querySelectorAll('.flow-dot').forEach(dot => {
            dot.classList.add('active');
        });
        document.getElementById('cart-summary').classList.remove('show');
    }

    // Shipping option change
    document.getElementById('shipping-option').addEventListener('change', function() {
        updateShippingPrice();
        updateCartSummary();
        updateOrderSummary();
    });

    // Country change handler
    document.getElementById('country').addEventListener('change', function() {
        const isInternational = this.value !== 'US';
        updateShippingOptions(isInternational);
    });

    function updateShippingOptions(isInternational) {
        const shippingSelect = document.getElementById('shipping-option');
        const domesticGroup = shippingSelect.querySelector('optgroup[label="US Domestic"]');
        const intlGroup = shippingSelect.querySelector('optgroup[label="International"]');
        
        if (isInternational) {
            domesticGroup.style.display = 'none';
            intlGroup.style.display = '';
            shippingSelect.value = 'usps_intl_pri';
        } else {
            domesticGroup.style.display = '';
            intlGroup.style.display = 'none';
            shippingSelect.value = 'usps_ground';
        }
        
        updateShippingPrice();
        updateCartSummary();
        updateOrderSummary();
    }

    // Initialize with no product selected
    document.getElementById('checkout-btn').disabled = true;
    </script>
</body>
</html>
