<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Charmers Checkout</title>
    
    <!-- External CSS File -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <header>
        <h1>Charmers Checkout</h1>
    </header>

    <div class="banner">
        We're on eBay! <a href="https://ebay.us/m/S51i6y" target="_blank">Visit our store</a>
    </div>

    <main>
        <!-- Customer info -->
        <div class="section" id="customer-info">
            <h2>Customer information</h2>
            <label for="name">Name <span class="required">*</span></label>
            <input id="name" type="text" placeholder="Full name" required>
            <div class="field-error" id="name-error">Please enter your name</div>

            <label for="email">Email <span class="required">*</span></label>
            <input id="email" type="email" placeholder="you@example.com" required>
            <div class="field-error" id="email-error">Please enter a valid email address</div>

            <label for="phone">Phone</label>
            <input id="phone" type="tel" placeholder="Optional">
        </div>

        <!-- Bracelet selection -->
        <div class="section" id="bracelet-section">
            <h2>Choose your bracelet</h2>

            <label for="bracelet-type">Bracelet type</label>
            <select id="bracelet-type">
                <option value="birthstone">Charmers Birthstone Series</option>
                <option value="heart">Charmers Heart Bracelet</option>
                <option value="custom">Create Your Own Bracelet</option>
            </select>

            <!-- Birthstone -->
            <div id="birthstone-fields" class="bracelet-specific">
                <label for="birthstone">Your birthstone</label>
                <input id="birthstone" type="text" placeholder="e.g., April, May" >

                <label for="birthstone-size">Size <span class="required">*</span></label>
                <select id="birthstone-size" class="size-dropdown">
                    <option value="">Select size</option>
                    <option value="small" data-price="5">Small — $5</option>
                    <option value="medium" data-price="9">Medium — $9</option>
                    <option value="large" data-price="11">Large — $11</option>
                    <option value="xlarge" data-price="15">Extra Large — $15</option>
                </select>
                <div class="field-error" id="birthstone-size-error">Please select a size</div>

                <label for="birthstone-personalization">Personalization text</label>
                <textarea id="birthstone-personalization" rows="2" placeholder="Optional"></textarea>

                <p style="margin-top:8px; font-size:0.9rem;">
                    10% of profits donated to Montessori School of Franklin.
                </p>
            </div>

            <!-- Heart bracelet -->
            <div id="heart-fields" class="bracelet-specific hidden">
                <p style="font-size:0.9rem;">Colors fixed to pink & purple.</p>

                <label for="heart-size">Size <span class="required">*</span></label>
                <select id="heart-size" class="size-dropdown">
                    <option value="">Select size</option>
                    <option value="small" data-price="5">Small — $5</option>
                    <option value="medium" data-price="9">Medium — $9</option>
                    <option value="large" data-price="11">Large — $11</option>
                    <option value="xlarge" data-price="15">Extra Large — $15</option>
                </select>
                <div class="field-error" id="heart-size-error">Please select a size</div>

                <label for="heart-personalization">Personalization text</label>
                <textarea id="heart-personalization" rows="2" placeholder="Optional"></textarea>
            </div>

            <!-- Custom bracelet -->
            <div id="custom-fields" class="bracelet-specific hidden">
                <label for="custom-feature">What do you want it to feature?</label>
                <input id="custom-feature" type="text" placeholder="Describe your design or theme">

                <!-- Color dropdown #1 -->
                <label for="custom-color">Color</label>
                <select id="custom-color" class="color-dropdown">
                    <option value="">Select color</option>
                    <option value="red">Red</option>
                    <option value="orange">Orange</option>
                    <option value="yellow">Yellow</option>
                    <option value="green">Green</option>
                    <option value="teal">Teal</option>
                    <option value="blue">Blue</option>
                    <option value="navy">Navy</option>
                    <option value="cyan">Cyan</option>
                    <option value="purple">Purple</option>
                    <option value="magenta">Magenta</option>
                    <option value="pink">Pink</option>
                    <option value="lavender">Lavender</option>
                    <option value="white">White</option>
                    <option value="black">Black</option>
                    <option value="gray">Gray</option>
                    <option value="brown">Brown</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                    <option value="lime">Lime</option>
                    <option value="maroon">Maroon</option>
                    <option value="olive">Olive</option>
                    <option value="indigo">Indigo</option>
                    <option value="beige">Beige</option>
                    <option value="mint">Mint</option>
                    <option value="peach">Peach</option>
                    <option value="coral">Coral</option>
                    <option value="turquoise">Turquoise</option>
                    <option value="rose">Rose</option>
                    <option value="cream">Cream</option>
                    <option value="bronze">Bronze</option>
                    <option value="chartreuse">Chartreuse</option>
                </select>
                <!-- Custom color input -->
                <label for="custom-color-custom">Or enter a custom color</label>
                <input id="custom-color-custom" type="text" placeholder="Custom color name">

                <!-- Color dropdown #2 -->
                <label for="custom-color2">Optional second color</label>
                <select id="custom-color2" class="color-dropdown-2">
                    <option value="">Select color</option>
                    <option value="red">Red</option>
                    <option value="orange">Orange</option>
                    <option value="yellow">Yellow</option>
                    <option value="green">Green</option>
                    <option value="teal">Teal</option>
                    <option value="blue">Blue</option>
                    <option value="navy">Navy</option>
                    <option value="cyan">Cyan</option>
                    <option value="purple">Purple</option>
                    <option value="magenta">Magenta</option>
                    <option value="pink">Pink</option>
                    <option value="lavender">Lavender</option>
                    <option value="white">White</option>
                    <option value="black">Black</option>
                    <option value="gray">Gray</option>
                    <option value="brown">Brown</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                    <option value="lime">Lime</option>
                    <option value="maroon">Maroon</option>
                    <option value="olive">Olive</option>
                    <option value="indigo">Indigo</option>
                    <option value="beige">Beige</option>
                    <option value="mint">Mint</option>
                    <option value="peach">Peach</option>
                    <option value="coral">Coral</option>
                    <option value="turquoise">Turquoise</option>
                    <option value="rose">Rose</option>
                    <option value="cream">Cream</option>
                    <option value="bronze">Bronze</option>
                    <option value="chartreuse">Chartreuse</option>
                </select>

                <label for="custom-size">Size <span class="required">*</span></label>
                <select id="custom-size" class="size-dropdown">
                    <option value="">Select size</option>
                    <option value="small" data-price="5">Small — $5</option>
                    <option value="medium" data-price="9">Medium — $9</option>
                    <option value="large" data-price="11">Large — $11</option>
                    <option value="xlarge" data-price="15">Extra Large — $15</option>
                </select>
                <div class="field-error" id="custom-size-error">Please select a size</div>

                <label for="donation">Donate to</label>
                <select id="donation">
                    <option value="remove_co2">Remove CO₂ from our environment (default)</option>
                    <option value="msf">MSF (Montessori School of Franklin)</option>
                    <option value="none">No one</option>
                </select>

                <label for="custom-personalization">Personalization text</label>
                <textarea id="custom-personalization" rows="2" placeholder="Optional"></textarea>
            </div>
        </div>

        <!-- Shipping -->
        <div class="section" id="shipping-section">
            <h2>Shipping</h2>
            <label for="shipping-option">Shipping option <span class="required">*</span></label>
            <select id="shipping-option">
                <option value="">Select shipping</option>
                <option value="usps_ground" data-price="9">USPS Ground Advantage — $9</option>
                <option value="usps_priority" data-price="11">USPS Priority Mail — $11</option>
                <option value="usps_express" data-price="29">USPS Priority Mail Express — $29</option>
                <option value="ups_exp" data-price="93">UPS Worldwide Expedited — $93</option>
                <option value="ups_expr" data-price="119">UPS Worldwide Express — $119</option>
                <option value="usps_intl_exp" data-price="178">USPS Priority Mail Express International — $178</option>
            </select>
            <div class="field-error" id="shipping-error">Please select a shipping option</div>

            <label for="address1">Street address <span class="required">*</span></label>
            <input id="address1" type="text" placeholder="Address line 1" required>
            <div class="field-error" id="address1-error">Please enter your street address</div>

            <label for="address2">Street address 2</label>
            <input id="address2" type="text" placeholder="Address line 2">

            <div class="inline-group">
                <div>
                    <label for="city">City <span class="required">*</span></label>
                    <input id="city" type="text" placeholder="City" required>
                    <div class="field-error" id="city-error">Please enter your city</div>
                </div>
                <div>
                    <label for="state">State / Province <span class="required">*</span></label>
                    <input id="state" type="text" placeholder="State" required>
                    <div class="field-error" id="state-error">Please enter your state/province</div>
                </div>
            </div>

            <div class="inline-group">
                <div>
                    <label for="postal">Postal code <span class="required">*</span></label>
                    <input id="postal" type="text" placeholder="ZIP / Postal code" required>
                    <div class="field-error" id="postal-error">Please enter your postal code</div>
                </div>
                <div>
                    <label for="country">Country <span class="required">*</span></label>
                    <input id="country" type="text" placeholder="Country" required>
                    <div class="field-error" id="country-error">Please enter your country</div>
                </div>
            </div>
        </div>

        <!-- Processing -->
        <div class="section" id="processing-section">
            <h2>Processing</h2>
            <label for="processing-option">Processing option <span class="required">*</span></label>
            <select id="processing-option">
                <option value="">Select processing</option>
                <option value="24h" data-price="0.50">Charmers 24 Hour Processing™ — $0.50</option>
                <option value="7day" data-price="0">Charmers Seven Day 12 Hours Processing™ — $0.00</option>
            </select>
            <div class="field-error" id="processing-error">Please select a processing option</div>
        </div>

        <!-- Coupon -->
        <div class="section" id="coupon-section">
            <h2>Coupon</h2>
            <label for="coupon-code">Enter coupon code</label>
            <input id="coupon-code" type="text" placeholder="Optional">
            <div id="coupon-message"></div>
        </div>

        <!-- Totals panel -->
        <div id="totals-panel">
            <div><span>Bracelet Price:</span><span id="bracelet-price">$0.00</span></div>
            <div><span>Coupon Savings:</span><span id="coupon-savings">-$0.00</span></div>
            <div><span>Processing Fee:</span><span id="processing-fee">$0.00</span></div>
            <div><span>Shipping:</span><span id="shipping-fee">$0.00</span></div>
            <div><span>Additional Fee:</span><span id="additional-fee">$0.00</span></div>
            <div id="final-total"><span>FINAL TOTAL:</span><span id="final-total-amount">$0.00</span></div>
        </div>

        <!-- Payment section -->
        <div class="section" id="payment-section">
            <h2>Payment</h2>

            <!-- Payment Request Button container -->
            <div id="payment-request-button" class="hidden"></div>

            <!-- Card Element container -->
            <div id="card-element" style="margin-top:16px;"></div>

            <!-- Display errors -->
            <div id="card-errors" role="alert" style="color:#c00; margin-top:8px;"></div>

            <!-- Pay button for card -->
            <button id="card-button" data-secret="">Pay</button>
        </div>

        <!-- After payment success -->
        <div id="success-section" class="section hidden">
            <h2>Payment successful!</h2>
            <p>Thank you for your order. Please click below to send your order details via email.</p>

            <button id="email-button">Complete Order</button>
        </div>
    </main>

    <script>
    (async function(){
        // --------- CONFIG ----------
        const stripePublicKey = 'pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc';
        const paymentIntentUrl = 'https://Pay-Charmersv2.onrender.com/create-payment-intent';

        // Utility
        function fmtMoney(val) {
            return '$' + val.toFixed(2);
        }

        // DOM elements
        const braceletType = document.getElementById('bracelet-type');
        const birthstoneFields = document.getElementById('birthstone-fields');
        const heartFields = document.getElementById('heart-fields');
        const customFields = document.getElementById('custom-fields');

        const sizeDropdowns = document.querySelectorAll('.size-dropdown');
        const shippingOption = document.getElementById('shipping-option');
        const processingOption = document.getElementById('processing-option');

        const couponCodeInput = document.getElementById('coupon-code');
        const couponMessage = document.getElementById('coupon-message');

        const totals = {
            bracelet: 0,
            coupon: 0,
            processing: 0,
            shipping: 0,
            additional: 0,
        };

        const braceletPriceEl = document.getElementById('bracelet-price');
        const couponSavingsEl = document.getElementById('coupon-savings');
        const processingFeeEl = document.getElementById('processing-fee');
        const shippingFeeEl = document.getElementById('shipping-fee');
        const additionalFeeEl = document.getElementById('additional-fee');
        const finalTotalEl = document.getElementById('final-total-amount');

        const cardButton = document.getElementById('card-button');
        const paymentRequestButtonDiv = document.getElementById('payment-request-button');
        const cardErrors = document.getElementById('card-errors');

        const successSection = document.getElementById('success-section');
        const emailButton = document.getElementById('email-button');

        // Customer info fields
        const nameField = document.getElementById('name');
        const emailField = document.getElementById('email');
        const phoneField = document.getElementById('phone');

        // Address
        const address1Field = document.getElementById('address1');
        const address2Field = document.getElementById('address2');
        const cityField = document.getElementById('city');
        const stateField = document.getElementById('state');
        const postalField = document.getElementById('postal');
        const countryField = document.getElementById('country');

        // Error fields
        const errorFields = {
            name: document.getElementById('name-error'),
            email: document.getElementById('email-error'),
            birthstoneSize: document.getElementById('birthstone-size-error'),
            heartSize: document.getElementById('heart-size-error'),
            customSize: document.getElementById('custom-size-error'),
            shipping: document.getElementById('shipping-error'),
            address1: document.getElementById('address1-error'),
            city: document.getElementById('city-error'),
            state: document.getElementById('state-error'),
            postal: document.getElementById('postal-error'),
            country: document.getElementById('country-error'),
            processing: document.getElementById('processing-error')
        };

        // Coupon state
        let couponApplied = null;

        // Keep track of whether payment succeeded
        let paymentSucceeded = false;

        // --------- UI logic ----------
        function showFieldsForType(type){
            birthstoneFields.classList.add('hidden');
            heartFields.classList.add('hidden');
            customFields.classList.add('hidden');
            if(type === 'birthstone') birthstoneFields.classList.remove('hidden');
            if(type === 'heart') heartFields.classList.remove('hidden');
            if(type === 'custom') customFields.classList.remove('hidden');
            recalcTotals();
        }
        braceletType.addEventListener('change', e => {
            showFieldsForType(e.target.value);
        });
        showFieldsForType(braceletType.value);

        // Get bracelet price from selected size dropdown
        function getBraceletPrice(){
            let price = 0;
            const type = braceletType.value;
            let selectedOption;
            if(type === 'birthstone'){
                selectedOption = document.getElementById('birthstone-size').selectedOptions[0];
            }else if(type === 'heart'){
                selectedOption = document.getElementById('heart-size').selectedOptions[0];
            }else{
                selectedOption = document.getElementById('custom-size').selectedOptions[0];
            }
            if(selectedOption && selectedOption.dataset.price){
                price = parseFloat(selectedOption.dataset.price);
            }
            return price;
        }

        // Get processing fee
        function getProcessingFee(){
            const option = processingOption.selectedOptions[0];
            if(option && option.dataset.price){
                return parseFloat(option.dataset.price);
            }
            return 0;
        }

        // Get shipping fee
        function getShippingFee(){
            const option = shippingOption.selectedOptions[0];
            if(option && option.dataset.price){
                return parseFloat(option.dataset.price);
            }
            return 0;
        }

        // Coupon validation
        function validateCoupon(code){
            const today = new Date();
            const mm = today.getMonth()+1;
            const dd = today.getDate();
            const day = today.getDay();

            const isNewCustomer = localStorage.getItem('hasOrdered') === null;

            if(!code) return null;

            code = code.trim();
            if(code.toLowerCase() === 'cybermonday25'.toLowerCase()){
                if(day === 1 && mm === 11 && dd >= 20 && dd <= 30 && isNewCustomer){
                    return {code:'CyberMonday25', percent:25};
                }
                return {error:'Valid only on Cyber Monday for new customers.'};
            }
            if(code.toLowerCase() === 'christmasd34'.toLowerCase()){
                if(mm === 12 && (dd === 24 || dd === 25)){
                    return {code:'ChristmasD34', percent:34};
                }
                return {error:'Valid only on Dec 24 or 25.'};
            }
            return {error:'Invalid coupon code.'};
        }

        function applyCoupon(){
            couponApplied = null;
            couponMessage.textContent = '';
            couponMessage.className = '';
            const code = couponCodeInput.value;
            if(!code) {
                recalcTotals();
                return;
            }
            const res = validateCoupon(code);
            if(res && res.error){
                couponMessage.textContent = res.error;
                couponMessage.className = 'coupon-error';
                recalcTotals();
                return;
            }
            if(res){
                couponApplied = res;
                couponMessage.textContent = 'Coupon applied: ' + res.code;
                couponMessage.className = 'coupon-success';
                recalcTotals();
            }
        }

        couponCodeInput.addEventListener('blur', applyCoupon);
        couponCodeInput.addEventListener('change', applyCoupon);
        couponCodeInput.addEventListener('keyup', (e)=>{
            if(e.key === 'Enter') applyCoupon();
        });

        // Recalc totals
        function recalcTotals(){
            totals.bracelet = getBraceletPrice();
            if(couponApplied && couponApplied.percent){
                totals.coupon = totals.bracelet * (couponApplied.percent / 100);
            }else{
                totals.coupon = 0;
            }
            totals.processing = getProcessingFee();
            totals.shipping = getShippingFee();
            totals.additional = 0;

            braceletPriceEl.textContent = fmtMoney(totals.bracelet);
            couponSavingsEl.textContent = '-' + fmtMoney(totals.coupon);
            processingFeeEl.textContent = fmtMoney(totals.processing);
            shippingFeeEl.textContent = fmtMoney(totals.shipping);
            additionalFeeEl.textContent = fmtMoney(totals.additional);

            const final = totals.bracelet - totals.coupon + totals.processing + totals.shipping + totals.additional;
            finalTotalEl.textContent = fmtMoney(final);

            cardButton.disabled = final <= 0 || !validateRequired();
        }

        // Validate required fields for enabling payment
        function validateRequired(){
            let isValid = true;
            
            Object.values(errorFields).forEach(field => {
                if(field) field.style.display = 'none';
            });
            document.querySelectorAll('input, select').forEach(el => {
                el.classList.remove('error');
            });

            if(!nameField.value.trim()) {
                errorFields.name.style.display = 'block';
                nameField.classList.add('error');
                isValid = false;
            }
            
            if(!emailField.value.trim() || !isValidEmail(emailField.value)) {
                errorFields.email.style.display = 'block';
                emailField.classList.add('error');
                isValid = false;
            }
            
            if(!shippingOption.value) {
                errorFields.shipping.style.display = 'block';
                shippingOption.classList.add('error');
                isValid = false;
            }
            
            if(!address1Field.value.trim()) {
                errorFields.address1.style.display = 'block';
                address1Field.classList.add('error');
                isValid = false;
            }
            
            if(!cityField.value.trim()) {
                errorFields.city.style.display = 'block';
                cityField.classList.add('error');
                isValid = false;
            }
            
            if(!stateField.value.trim()) {
                errorFields.state.style.display = 'block';
                stateField.classList.add('error');
                isValid = false;
            }
            
            if(!postalField.value.trim()) {
                errorFields.postal.style.display = 'block';
                postalField.classList.add('error');
                isValid = false;
            }
            
            if(!countryField.value.trim()) {
                errorFields.country.style.display = 'block';
                countryField.classList.add('error');
                isValid = false;
            }
            
            if(!processingOption.value) {
                errorFields.processing.style.display = 'block';
                processingOption.classList.add('error');
                isValid = false;
            }
            
            const type = braceletType.value;
            if(type === 'birthstone'){
                if(!document.getElementById('birthstone-size').value) {
                    errorFields.birthstoneSize.style.display = 'block';
                    document.getElementById('birthstone-size').classList.add('error');
                    isValid = false;
                }
            } else if(type === 'heart'){
                if(!document.getElementById('heart-size').value) {
                    errorFields.heartSize.style.display = 'block';
                    document.getElementById('heart-size').classList.add('error');
                    isValid = false;
                }
            } else {
                if(!document.getElementById('custom-size').value) {
                    errorFields.customSize.style.display = 'block';
                    document.getElementById('custom-size').classList.add('error');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Email validation helper
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Attach change listeners to recalc
        document.querySelectorAll('select').forEach(el=>{
            el.addEventListener('change', recalcTotals);
        });
        document.querySelectorAll('input').forEach(el=>{
            el.addEventListener('change', recalcTotals);
        });
        document.querySelectorAll('textarea').forEach(el=>{
            el.addEventListener('change', recalcTotals);
        });

        // --------- Stripe setup ----------
        const stripe = Stripe(stripePublicKey, {apiVersion: "2025-11-17.acacia"});
        const elements = stripe.elements();

        // Payment Request Button for Apple Pay / Google Pay
        const paymentRequest = stripe.paymentRequest({
            country: 'US',
            currency: 'usd',
            total: {
                label: 'Total',
                amount: 0,
            },
            requestPayerName: true,
            requestPayerEmail: true,
        });

        const prButton = elements.create('paymentRequestButton', {
            paymentRequest,
        });

        // Check availability
        const prCanMake = await paymentRequest.canMakePayment();
        if(prCanMake && (prCanMake.applePay || prCanMake.googlePay)) {
            paymentRequestButtonDiv.classList.remove('hidden');
            prButton.mount('#payment-request-button');

            const updatePRTotal = () => {
                const final = totals.bracelet - totals.coupon + totals.processing + totals.shipping + totals.additional;
                const cents = Math.round(final * 100);
                paymentRequest.update({
                    total: {
                        label: 'Total',
                        amount: cents,
                    }
                });
            };

            document.querySelectorAll('select, input, textarea').forEach(el=>{
                el.addEventListener('change', updatePRTotal);
            });

            paymentRequest.on('token', async (ev) => {
                if(!validateRequired()){
                    ev.complete('fail');
                    alert('Please complete all required fields before paying.');
                    return;
                }

                const final = totals.bracelet - totals.coupon + totals.processing + totals.shipping + totals.additional;
                const amountCents = Math.round(final * 100);
                const response = await fetch(paymentIntentUrl, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        amount: amountCents,
                        currency:'usd',
                    })
                });
                const pi = await response.json();
                if(pi.error){
                    ev.complete('fail');
                    cardErrors.textContent = pi.error;
                    return;
                }

                const result = await stripe.confirmCardPayment(
                    pi.clientSecret,
                    {payment_method: ev.token.id},
                    {handleActions: false}
                );
                if(result.error){
                    ev.complete('fail');
                    cardErrors.textContent = result.error.message;
                }else{
                    ev.complete('success');
                    paymentSucceeded = true;
                    showSuccess();
                }
            });
        } else {
            paymentRequestButtonDiv.classList.add('hidden');
        }

        // Card Element
        const style = {
            base: {
                color: "#32325d",
                fontFamily: 'Arial, sans-serif',
                fontSmoothing: "antialiased",
                fontSize: "16px",
                "::placeholder": { color: "#a0a0a0" }
            },
            invalid: { color: "#fa755a", iconColor: "#fa755a" }
        };
        const card = elements.create("card", {style: style});
        card.mount("#card-element");

        card.on('change', (event)=>{
            if(event.error){
                cardErrors.textContent = event.error.message;
            }else{
                cardErrors.textContent = '';
            }
        });

        // Card payment handler
        cardButton.addEventListener('click', async (e)=>{
            e.preventDefault();

            if(!validateRequired()){
                alert('Please complete all required fields.');
                return;
            }

            cardButton.disabled = true;
            document.body.classList.add('loading');

            const final = totals.bracelet - totals.coupon + totals.processing + totals.shipping + totals.additional;
            const amountCents = Math.round(final * 100);

            let piResponse;
            try{
                piResponse = await fetch(paymentIntentUrl, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        amount: amountCents,
                        currency:'usd',
                    })
                });
            }catch(err){
                cardErrors.textContent = 'Error contacting payment server.';
                cardButton.disabled = false;
                document.body.classList.remove('loading');
                return;
            }
            const pi = await piResponse.json();
            if(pi.error){
                cardErrors.textContent = pi.error;
                cardButton.disabled = false;
                document.body.classList.remove('loading');
                return;
            }

            const {error, paymentIntent} = await stripe.confirmCardPayment(pi.clientSecret, {
                payment_method: {
                    card:card,
                    billing_details:{
                        name:nameField.value,
                        email:emailField.value,
                        phone:phoneField.value,
                        address:{
                            line1:address1Field.value,
                            line2:address2Field.value,
                            city:cityField.value,
                            state:stateField.value,
                            postal_code:postalField.value,
                            country:countryField.value
                        }
                    }
                }
            });

            if(error){
                cardErrors.textContent = error.message;
                cardButton.disabled = false;
                document.body.classList.remove('loading');
            }else if(paymentIntent.status === 'succeeded'){
                paymentSucceeded = true;
                showSuccess();
                document.body.classList.remove('loading');
            }
        });

        function showSuccess(){
            document.getElementById('payment-section').classList.add('hidden');
            successSection.classList.remove('hidden');
            localStorage.setItem('hasOrdered','yes');
        }

        // Email button
        emailButton.addEventListener('click',()=>{
            const type = braceletType.value;
            let details = '';
            if(type === 'birthstone'){
                details += `Type: Charmers Birthstone Series\n`;
                details += `Birthstone: ${document.getElementById('birthstone').value}\n`;
                details += `Size: ${document.getElementById('birthstone-size').value}\n`;
                details += `Personalization: ${document.getElementById('birthstone-personalization').value}\n`;
            }else if(type === 'heart'){
                details += `Type: Charmers Heart Bracelet\n`;
                details += `Size: ${document.getElementById('heart-size').value}\n`;
                details += `Personalization: ${document.getElementById('heart-personalization').value}\n`;
            }else{
                details += `Type: Create Your Own Bracelet\n`;
                details += `Feature: ${document.getElementById('custom-feature').value}\n`;
                const col = document.getElementById('custom-color').value;
                const colCustom = document.getElementById('custom-color-custom').value.trim();
                const col2 = document.getElementById('custom-color2').value;
                details += `Color: ${colCustom || col || 'N/A'}\n`;
                details += `Second Color: ${col2 || 'N/A'}\n`;
                details += `Size: ${document.getElementById('custom-size').value}\n`;
                details += `Donation: ${document.getElementById('donation').value}\n`;
                details += `Personalization: ${document.getElementById('custom-personalization').value}\n`;
            }

            details += `\n--- Totals ---\n`;
            details += `Bracelet Price: ${braceletPriceEl.textContent}\n`;
            details += `Coupon Savings: ${couponSavingsEl.textContent}\n`;
            details += `Processing Fee: ${processingFeeEl.textContent}\n`;
            details += `Shipping: ${shippingFeeEl.textContent}\n`;
            details += `Additional Fee: ${additionalFeeEl.textContent}\n`;
            details += `FINAL TOTAL: ${finalTotalEl.textContent}\n`;

            details += `\n--- Shipping ---\n`;
            details += `Street: ${address1Field.value}\n`;
            details += `Street2: ${address2Field.value}\n`;
            details += `City: ${cityField.value}\n`;
            details += `State: ${stateField.value}\n`;
            details += `Postal: ${postalField.value}\n`;
            details += `Country: ${countryField.value}\n`;

            details += `\n--- Customer ---\n`;
            details += `Name: ${nameField.value}\n`;
            details += `Email: ${emailField.value}\n`;
            details += `Phone: ${phoneField.value || 'N/A'}\n`;

            if(couponApplied && couponApplied.code){
                details += `\nCoupon code used: ${couponApplied.code}\n`;
            }

            const subject = encodeURIComponent(`New Charmers Order – ${nameField.value}`);
            const body = encodeURIComponent(details);

            const mailto = `mailto:Charmers2346@gmail.com?subject=${subject}&body=${body}`;
            window.location.href = mailto;
        });

        // Initial calc
        recalcTotals();
    })();
    </script>
</body>
</html>
