<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Charmers Checkout</title>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.google.com/recaptcha/enterprise.js" async defer></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to right, #a64ac9, #ff69b4);
      color: white;
      padding: 20px;
    }
    .container {
      background: rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: auto;
    }
    input, select, textarea {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: none;
      border-radius: 5px;
    }
    .btn {
      background: white;
      color: #a64ac9;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
      margin-top: 10px;
    }
    .error, .success {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .error {
      background-color: #ff4d4d;
      color: white;
    }
    .success {
      background-color: #32cd32;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Charmers Secure Checkout</h2>
    <form id="charmers-form">
      <label>Name</label>
      <input type="text" id="name" required>
      <label>Email</label>
      <input type="email" id="email" required>
      <label>Phone Number (optional)</label>
      <input type="text" id="phone">
      <label>Bracelet Text</label>
      <input type="text" id="bracelet" required>
      <label>Shipping Option</label>
      <select id="shipping">
        <option value="9">Ground Advantage - $9</option>
        <option value="13">Priority Mail - $13</option>
        <option value="25">Priority Mail Express - $25</option>
        <option value="47">Intl First Class - $47</option>
        <option value="78">Intl Priority - $78</option>
      </select>
      <label>Processing Time</label>
      <select id="processing">
        <option value="0.50">Charmers 24 Hour Processing - $0.50</option>
        <option value="0">Charmers Seven Day 12 Hours - Free</option>
      </select>
      <label>Street Address</label>
      <input type="text" id="address1" required>
      <label>Street Address 2 (optional)</label>
      <input type="text" id="address2">
      <label>City</label>
      <input type="text" id="city" required>
      <label>State/Territory</label>
      <input type="text" id="state">
      <label>Postal Code</label>
      <input type="text" id="postal" required>
      <label>Country</label>
      <input type="text" id="country" required>

      <div class="g-recaptcha" data-sitekey="6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"></div>
      <br>
      <input type="checkbox" id="tos"> I agree to the <a href="https://TOS.charmersbiz.org" target="_blank" style="color:white;text-decoration:underline;">ToS and usage policies</a>
      <br><br>

      <div id="card-element"><!-- Stripe CardElement --></div>
      <button type="button" class="btn" id="submitBtn">Complete Order</button>
      <button type="button" class="btn" id="sendEmailBtn" style="display:none;">Complete Order (Send Email)</button>
    </form>
    <div id="message"></div>
  </div>

  <script>
    const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    document.getElementById("submitBtn").addEventListener("click", async () => {
      if (!document.getElementById("tos").checked) {
        document.getElementById("message").innerHTML = '<div class="error">Error 403-001: You must agree to the Terms of Service to complete your order.</div>';
        return;
      }

      const braceletText = document.getElementById('bracelet').value;
      if (braceletText.length > 100) {
        document.getElementById("message").innerHTML = '<div class="error">Error 413-001: Bracelet text too long.</div>';
        return;
      }

      const basePrice = braceletText.length > 30 ? 1500 :
                        braceletText.length > 12 ? 1000 :
                        braceletText.length >= 6 ? 600 : 300;
      const shipping = parseFloat(document.getElementById("shipping").value);
      const processing = parseFloat(document.getElementById("processing").value);
      const totalAmount = basePrice + (shipping * 100) + (processing * 100) + 100; // Hidden tax/fee

      const response = await fetch("https://charmerspay.onrender.com/create-payment-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: totalAmount })
      });

      const { clientSecret } = await response.json();

      const result = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: card,
          billing_details: {
            name: document.getElementById('name').value
          }
        }
      });

      if (result.error) {
        let msg = "Error 402-999: An unknown error occurred.";
        if (result.error.code === "card_declined") msg = "Error 402-001: Card declined by your bank. Try again later.";
        else if (result.error.code === "incorrect_number") msg = "Error 402-002: Check the card number.";
        else if (result.error.code === "expired_card") msg = "Error 402-003: Your card has expired.";
        else if (result.error.code === "incorrect_cvc") msg = "Error 402-004: The security code is incorrect.";
        else if (result.error.code === "authentication_required") msg = "Error 402-005: Your card requires additional authentication.";
        document.getElementById("message").innerHTML = `<div class="error">${msg}</div>`;
      } else {
        document.getElementById("message").innerHTML = '<div class="success">✅ Order success — now press "Complete Order" again to email us your details.</div>';
        document.getElementById("sendEmailBtn").style.display = "inline-block";
      }
    });

    document.getElementById("sendEmailBtn").addEventListener("click", () => {
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const bracelet = document.getElementById('bracelet').value;
      const shipping = document.getElementById('shipping').selectedOptions[0].text;
      const processing = document.getElementById('processing').selectedOptions[0].text;
      const address1 = document.getElementById('address1').value;
      const address2 = document.getElementById('address2').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const postal = document.getElementById('postal').value;
      const country = document.getElementById('country').value;

      const mailtoLink = `mailto:office@charmersbiz.org?subject=New Bracelet Order&body=Name: ${name}%0AEmail: ${email}%0APhone: ${phone}%0ABracelet: ${bracelet}%0AShipping: ${shipping}%0AProcessing: ${processing}%0AAddress: ${address1} ${address2}, ${city}, ${state}, ${postal}, ${country}`;
      window.location.href = mailtoLink;
    });
  </script>
</body>
</html>
