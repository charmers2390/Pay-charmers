
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charmers Secure Checkout</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,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">
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.google.com/recaptcha/enterprise.js" async defer></script>
  <style>
    body {
      background: linear-gradient(to right, #a64ac9, #f76cae);
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      background: white;
      max-width: 500px;
      margin: auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    input, select {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      font-size: 16px;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    #total {
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }
    button {
      background-color: #e91e63;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Charmers Secure Checkout</h2>
    <form id="checkoutForm">
      <input type="text" name="name" id="name" placeholder="Name" required>
      <input type="email" name="email" id="email" placeholder="Email" required>
      <input type="text" name="phone" id="phone" placeholder="Phone Number (optional)">
      <input type="text" name="bracelet" id="bracelet" placeholder="Bracelet Text" required>
      <select id="shipping" required>
        <option value="">Shipping Option</option>
        <option value="9">Ground Advantage - $9</option>
        <option value="13">Priority Mail - $13</option>
        <option value="25">Priority Mail Express - $25</option>
        <option value="47">USPS First Class International - $47</option>
        <option value="78">USPS Priority Mail International - $78</option>
      </select>
      <select id="processing" required>
        <option value="">Processing Time</option>
        <option value="0">Charmers 7 Day 12 Hours Processing™ - $0</option>
        <option value="0.5">Charmers 24 Hour Processing™ - $0.50</option>
      </select>
      <input type="text" id="street1" placeholder="Street Address" required>
      <input type="text" id="street2" placeholder="Street Address 2 (optional)">
      <input type="text" id="city" placeholder="City" required>
      <input type="text" id="state" placeholder="State/Territory (optional)">
      <input type="text" id="zip" placeholder="Postal Code" required>
      <input type="text" id="country" placeholder="Country" required>

      <div class="g-recaptcha" data-sitekey="6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO" data-action="LOGIN"></div>

      <label><input type="checkbox" id="agree"> I agree to the <a href="https://tos.charmersbiz.org" target="_blank">ToS and usage policies</a></label>

      <div id="total">Order Total: $0.00</div>

      <div id="card-element"><!-- Stripe injects here --></div>

      <div id="error-msg" class="error"></div>
      <button type="submit">Complete Order</button>

      <p style="text-align:center; font-size: 14px;">
        Powered by Stripe<br>
        For any refunds needed, <a href="https://refund.charmersbiz.org" target="_blank">click here</a>.
      </p>
    </form>
  </div>

  <script>
    document.getElementById("checkoutForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const bracelet = document.getElementById("bracelet").value.trim();
      const shipping = parseFloat(document.getElementById("shipping").value);
      const processing = parseFloat(document.getElementById("processing").value);
      const zip = document.getElementById("zip").value.trim();
      const country = document.getElementById("country").value.trim();
      const agree = document.getElementById("agree").checked;
      const captcha = document.querySelector(".g-recaptcha-response").value;

      let errors = [];

      if (!name || !email || !bracelet || !shipping || !processing || !zip || !country)
        errors.push("ERR-001: Please fill out all required fields.");
      if (!agree)
        errors.push("ERR-002: You must agree to the ToS and usage policies.");
      if (!captcha)
        errors.push("ERR-003: Please verify you are not a robot.");

      const errorBox = document.getElementById("error-msg");
      if (errors.length > 0) {
        errorBox.innerHTML = errors.join("<br>");
      } else {
        errorBox.innerHTML = "Order success! Now press Complete Order again to email it.";
        // Show 2nd submit or trigger mailto: link
      }
    });

    document.getElementById("bracelet").addEventListener("input", updateTotal);
    document.getElementById("shipping").addEventListener("change", updateTotal);
    document.getElementById("processing").addEventListener("change", updateTotal);

    function updateTotal() {
      const bracelet = document.getElementById("bracelet").value.length;
      let base = bracelet > 100 ? 0 : bracelet > 30 ? 15 : bracelet > 12 ? 10 : bracelet >= 6 ? 6 : 3;
      const shipping = parseFloat(document.getElementById("shipping").value) || 0;
      const processing = parseFloat(document.getElementById("processing").value) || 0;
      const stripeFee = 0.30 + 0.029 * (base + shipping + processing);
      const total = (base + shipping + processing + stripeFee).toFixed(2);
      document.getElementById("total").textContent = "Order Total: $" + total;
    }
  </script>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");

  const elements = stripe.elements();
  const style = { base: { color: "#32325d", fontFamily: "Arial, sans-serif", fontSmoothing: "antialiased", fontSize: "16px", "::placeholder": { color: "#a0aec0" } }, invalid: { color: "#fa755a", iconColor: "#fa755a" } };
  const card = elements.create("card", { style: style });
  card.mount("#card-element");

  const form = document.getElementById("payment-form");
  const errorDisplay = document.getElementById("card-errors");

  form.addEventListener("submit", async function(e) {
    e.preventDefault();

    const tosChecked = document.getElementById("tos").checked;
    const captchaPassed = grecaptcha.getResponse();

    if (!tosChecked) {
      alert("Please agree to the ToS.");
      return;
    }

    if (!captchaPassed) {
      alert("Please verify you're not a robot.");
      return;
    }

    const { paymentMethod, error } = await stripe.createPaymentMethod({
      type: "card",
      card: card,
      billing_details: {
        name: form.name.value,
        email: form.email.value,
      },
    });

    if (error) {
      if (error.code === "incomplete_number") {
        errorDisplay.textContent = "ERR-002: Check the card number.";
      } else if (error.code === "card_declined") {
        errorDisplay.textContent = "ERR-003: The card was declined by your bank, try again later.";
      } else {
        errorDisplay.textContent = "ERR-999: " + error.message;
      }
    } else {
      // Call backend to create PaymentIntent
      const response = await fetch("https://charmerspay.onrender.com/create-payment-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          payment_method: paymentMethod.id,
          amount: Math.round(parseFloat(document.getElementById("order-total").textContent.replace("$", "")) * 100),
        })
      });

      const result = await response.json();
      if (result.error) {
        errorDisplay.textContent = "ERR-004: " + result.error;
        return;
      }

      const confirm = await stripe.confirmCardPayment(result.client_secret, {
        payment_method: paymentMethod.id
      });

      if (confirm.error) {
        errorDisplay.textContent = "ERR-005: " + confirm.error.message;
      } else {
        if (confirm.paymentIntent.status === "succeeded") {
          document.getElementById("complete-order-button").style.display = "block";
          document.getElementById("submit-button").style.display = "none";
          errorDisplay.textContent = "Order success, now press Complete Order to finish.";
        }
      }
    }
  });
</script>
</body>

</html>
