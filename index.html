<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Charmers Secure Checkout</title>
  <style>
    body {
      background: linear-gradient(to right, purple, pink);
      font-family: Arial, sans-serif;
      color: white;
    }
    .form-container {
      background-color: #2d2d2d;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      border-radius: 10px;
    }
    .form-container input, .form-container select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: none;
      border-radius: 5px;
    }
    .form-container button {
      background-color: hotpink;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
    }
    .form-container button:hover {
      background-color: deeppink;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    .checkbox-group input {
      margin-right: 10px;
    }
    .footer {
      font-size: 12px;
      text-align: center;
      margin-top: 10px;
    }
    #payment-message {
      text-align: center;
      color: lightgreen;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"></script>
</head>
<body>
  <div class="form-container">
    <h2>Charmers Secure Checkout</h2>
    <div id="payment-request-button" style="margin-bottom: 15px;"></div>
    <form id="checkoutForm">
      <input type="text" name="name" placeholder="Name" required />
      <input type="email" name="email" placeholder="Email" required />
      <input type="tel" name="phone" placeholder="Phone Number (optional)" />
      <input type="text" name="bracelet" placeholder="Bracelet Text" required />
      <select name="shipping" required>
        <option value="">Select Shipping</option>
        <option value="9">Ground Advantage - $9</option>
        <option value="13">Priority Mail - $13</option>
        <option value="25">Priority Mail Express - $25</option>
        <option value="47">USPS First Class International - $47</option>
        <option value="78">USPS Priority Mail International - $78</option>
      </select>
      <select name="processing" required>
        <option value="0.5">Charmers 24 Hour Processing™ - $0.50</option>
        <option value="0">Charmers Seven Day 12 Hours Processing™ - $0.00</option>
      </select>
      <input name="street" type="text" placeholder="Street Address" required />
      <input name="street2" type="text" placeholder="Street Address 2 (optional)" />
      <input name="city" type="text" placeholder="City" required />
      <input name="state" type="text" placeholder="State/Territory (optional)" />
      <input name="postal" type="text" placeholder="Postal Code" required />
      <input name="country" type="text" placeholder="Country" required />

      <div id="card-element"></div>
      <div id="card-errors" role="alert" style="color: red;"></div>

      <div class="checkbox-group">
        <input type="checkbox" id="tos" required />
        <label for="tos">I agree to the <a href="https://tos.charmersbiz.org" target="_blank">ToS and usage policies</a></label>
      </div>

      <div class="g-recaptcha" data-sitekey="6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"></div>
      <p id="total">Order Total: $0.00</p>
      <button id="submitBtn" type="submit">Complete Order</button>
      <p id="payment-message"></p>
    </form>
    <div class="footer">
      Powered by Stripe<br />
      For any refunds needed, <a href="https://refund.charmersbiz.org">click here</a>.
    </div>
  </div>
  <script>
    const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    const form = document.getElementById("checkoutForm");
    const messageEl = document.getElementById("payment-message");

    function calculateTotal() {
      const text = form.bracelet.value.trim();
      const shipping = parseFloat(form.shipping.value || 0);
      const processing = parseFloat(form.processing.value || 0);
      let bracelet = 0;
      if (text.length > 100) return "BLOCKED";
      if (text.length > 30) bracelet = 15;
      else if (text.length > 12) bracelet = 10;
      else if (text.length >= 6) bracelet = 6;
      else bracelet = 3;
      return (bracelet + shipping + processing).toFixed(2);
    }

    function gatherFormData() {
      const data = {};
      new FormData(form).forEach((v, k) => data[k] = v);
      return data;
    }

    function sendOrderToBackend(order, status, method) {
      fetch("https://charmerspay.onrender.com/save-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...order, status, method })
      }).catch(err => console.error("Order logging failed:", err));
    }

    async function confirmPayment(amount, method) {
      const res = await fetch("https://charmerspay.onrender.com/create-payment-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount })
      });
      const { clientSecret } = await res.json();
      return clientSecret;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      grecaptcha.enterprise.ready(async function () {
        const token = await grecaptcha.enterprise.execute('6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO', { action: 'submit' });
        const total = calculateTotal();
        if (total === "BLOCKED") return alert("Bracelet text too long.");

        const order = gatherFormData();
        const amount = parseFloat(total) * 100;
        try {
          const paymentMethod = await stripe.createPaymentMethod({
            type: "card",
            card: card,
            billing_details: { name: order.name, email: order.email }
          });

          const clientSecret = await confirmPayment(Math.round(amount));
          const confirmed = await stripe.confirmCardPayment(clientSecret, {
            payment_method: paymentMethod.paymentMethod.id
          });

          if (confirmed.error) {
            messageEl.textContent = "Your payment failed.";
            sendOrderToBackend(order, "failure", "card");
          } else {
            messageEl.textContent = "Your order was processed. Expect a confirmation email from Charmers soon.";
            sendOrderToBackend(order, "success", "card");
          }
        } catch (err) {
          console.error(err);
          messageEl.textContent = "Your payment failed.";
          sendOrderToBackend(gatherFormData(), "failure", "card");
        }
      });
    });

    const paymentRequest = stripe.paymentRequest({
      country: 'US',
      currency: 'usd',
      total: { label: 'Charmers Order', amount: 0 },
      requestPayerName: true,
      requestPayerEmail: true,
    });

    const prButton = elements.create("paymentRequestButton", { paymentRequest });

    paymentRequest.canMakePayment().then(result => {
      if (result) {
        prButton.mount("#payment-request-button");
      }
    });

    paymentRequest.on("paymentmethod", async (ev) => {
      const total = calculateTotal();
      if (total === "BLOCKED") {
        ev.complete("fail");
        return alert("Bracelet text too long.");
      }

      const order = gatherFormData();
      const amount = parseFloat(total) * 100;
      try {
        const clientSecret = await confirmPayment(Math.round(amount));
        const { error } = await stripe.confirmCardPayment(clientSecret, {
          payment_method: ev.paymentMethod.id
        }, { handleActions: false });

        if (error) {
          ev.complete("fail");
          messageEl.textContent = "Your payment failed.";
          sendOrderToBackend(order, "failure", "apple_or_google");
        } else {
          ev.complete("success");
          messageEl.textContent = "Your order was processed. Expect a confirmation email from Charmers soon.";
          sendOrderToBackend(order, "success", "apple_or_google");
        }
      } catch (err) {
        console.error(err);
        ev.complete("fail");
        messageEl.textContent = "Your payment failed.";
        sendOrderToBackend(order, "failure", "apple_or_google");
      }
    });
  </script>
</body>
</html>
