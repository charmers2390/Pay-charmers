<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charmers Checkout v3</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>
<!-- reCAPTCHA -->
<script src="https://www.google.com/recaptcha/enterprise.js" async defer></script>
<style>
body{font-family:Arial,system-ui;background:#050010;color:#fff;margin:0;padding:0}
.container{max-width:900px;margin:20px auto;padding:0 16px}
.card{background:#130527;border:1px solid #3b2560;border-radius:12px;padding:16px;margin-top:16px}
input,select{width:100%;padding:10px;margin:6px 0;background:#1a0f2b;border:1px solid #5b3f8c;border-radius:7px;color:#fff;font-size:14px}
button{padding:12px;border:none;border-radius:8px;background:#7c3aed;color:#fff;width:100%;margin-top:10px;font-size:15px;font-weight:600}
button.disabled{opacity:0.4;pointer-events:none}
.summary-line{display:flex;justify-content:space-between;margin:4px 0;font-size:14px}
.summary-line.total{margin-top:6px;font-size:18px;font-weight:bold;border-top:1px solid #433060;padding-top:6px}
#card-element{margin-top:12px;padding:12px;background:#0b0616;border-radius:8px;border:1px solid #4b3b78}
</style>
</head>
<body>
<div class='container'>

<!-- Customer Info -->
<div class="card">
<h2>Customer Information</h2>
<input id="name" placeholder="Full Name">
<input id="email" type="email" placeholder="Email">
<input id="phone" placeholder="Phone (optional)">
</div>

<!-- Address -->
<div class="card">
<h2>Shipping Address</h2>
<input id="addr1" placeholder="Street Address">
<input id="addr2" placeholder="Apt / Unit (optional)">
<input id="city" placeholder="City">
<input id="state" placeholder="State / Province">
<input id="zip" placeholder="Postal Code">
<select id="country">
<option value="US">United States</option>
</select>
</div>

<!-- Bracelet -->
<div class="card">
<h2>Bracelet Details</h2>
<select id="size">
<option value="5">Small – $5</option>
<option value="9">Medium – $9</option>
<option value="11">Large – $11</option>
<option value="15">XL – $15</option>
</select>
<input id="color" placeholder="Bracelet Color">

<h2 style="margin-top:12px;">Coupon</h2>
<input id="coupon" placeholder="Enter coupon code">
<div id="coupon-msg" style="font-size:12px;margin-top:4px;"></div>
</div>

<!-- Shipping -->
<div class="card">
<h2>Shipping</h2>
<select id="shipping">
<option value="9">USPS Ground Advantage – $9</option>
<option value="11">USPS Priority Mail – $11</option>
<option value="29">USPS Priority Mail Express – $29</option>
<option value="29">USPS First Class Intl – $29</option>
<option value="59">USPS Priority Mail International – $59</option>
<option value="101">USPS Priority Mail Express International – $101</option>
</select>

<h2 style="margin-top:12px;">Processing</h2>
<select id="processing">
<option value="0">CLU Ground – Free</option>
<option value="0.75">CLU Priority – $0.75</option>
<option value="1">CLU Priority Express – $1</option>
<option value="1">CLU International Ground – $1</option>
</select>
</div>

<!-- Payment -->
<div class="card">
<h2>Payment</h2>

<!-- Breakdown Above PRB -->
<div id="breakdown">
<div class="summary-line"><span>Bracelet</span><span id="sum-bracelet">$0.00</span></div>
<div class="summary-line"><span>Tax (9.5%)</span><span id="sum-tax">$0.00</span></div>
<div class="summary-line"><span>Processing</span><span id="sum-proc">$0.00</span></div>
<div class="summary-line"><span>Shipping</span><span id="sum-ship">$0.00</span></div>
<div class="summary-line total"><span>Total</span><span id="sum-total">$0.00</span></div>
</div>

<!-- Payment Request Buttons (Apple Pay / Google Pay) -->
<div id="payment-request-button" style="margin-top:12px;" class="disabled"></div>

<!-- Stripe Card Element -->
<div id="card-element"></div>

<!-- reCAPTCHA -->
<div style="margin-top:12px;">
<div class="g-recaptcha"
     data-sitekey="6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"
     data-callback="onRecaptcha"></div>
</div>

<!-- TOS -->
<div style="margin-top:10px;display:flex;align-items:flex-start;gap:6px;font-size:12px;">
<input type="checkbox" id="tos">
<label for="tos">I agree to the Terms of Service.</label>
</div>

<!-- Pay Button -->
<button id="paybtn" class="disabled">Complete Payment</button>
<div id="status" style="margin-top:10px;font-size:13px;min-height:16px;"></div>
</div>

<script>
// Stripe initialization
const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");
const elements = stripe.elements();
const card = elements.create("card");
card.mount("#card-element");

// Inputs
const nameI = document.getElementById("name");
const emailI = document.getElementById("email");
const phoneI = document.getElementById("phone");
const addr1 = document.getElementById("addr1");
const addr2 = document.getElementById("addr2");
const city = document.getElementById("city");
const state = document.getElementById("state");
const zip = document.getElementById("zip");
const country = document.getElementById("country");
const size = document.getElementById("size");
const color = document.getElementById("color");
const coupon = document.getElementById("coupon");
const ship = document.getElementById("shipping");
const proc = document.getElementById("processing");
const tos = document.getElementById("tos");
const paybtn = document.getElementById("paybtn");
const status = document.getElementById("status");
const prbContainer = document.getElementById("payment-request-button");

// Summary fields
const sBrace = document.getElementById("sum-bracelet");
const sTax = document.getElementById("sum-tax");
const sProc = document.getElementById("sum-proc");
const sShip = document.getElementById("sum-ship");
const sTotal = document.getElementById("sum-total");

// Utility
function money(x){ return "$" + x.toFixed(2); }

// Compute totals
function compute(){
  let b = parseFloat(size.value);
  if(coupon.value.trim().toUpperCase()==="CHARM10BLACKF"){
    b = b/2;
    document.getElementById("coupon-msg").textContent="50% Black Friday discount applied.";
    document.getElementById("coupon-msg").style.color="#4ade80";
  } else if(coupon.value.trim()===""){
    document.getElementById("coupon-msg").textContent="";
  } else {
    document.getElementById("coupon-msg").textContent="Invalid coupon.";
    document.getElementById("coupon-msg").style.color="#f87171";
  }

  const tax = b * 0.095;
  const p = parseFloat(proc.value);
  const sh = parseFloat(ship.value);
  const total = b + tax + p + sh;

  sBrace.textContent = money(b);
  sTax.textContent = money(tax);
  sProc.textContent = money(p);
  sShip.textContent = money(sh);
  sTotal.textContent = money(total);

  return Math.round(total*100);
}

// Form completion check
let recaptchaOK = false;
window.onRecaptcha = ()=>{ recaptchaOK=true; unlock(); };

function filled(){
  return (
    nameI.value && emailI.value && color.value &&
    addr1.value && city.value && state.value && zip.value
  );
}

function unlock(){
  if(filled() && recaptchaOK && tos.checked){
    paybtn.classList.remove("disabled");
    prbContainer.classList.remove("disabled");
  } else {
    paybtn.classList.add("disabled");
    prbContainer.classList.add("disabled");
  }
}

document.querySelectorAll("input,select").forEach(e=>{
  e.addEventListener("input",()=>{compute(); unlock();});
});

// Initialize totals
compute(); unlock();

// Payment Request Button
const paymentRequest = stripe.paymentRequest({
  country:"US",
  currency:"usd",
  total:{ label:"Charmers Order", amount: compute() },
  requestPayerName:true,
  requestPayerEmail:true
});

paymentRequest.canMakePayment().then(res=>{
  if(res){
    const prButton = elements.create("paymentRequestButton", { paymentRequest });
    prButton.mount("#payment-request-button");
  } else {
    prbContainer.style.display="none";
  }
});

// PRB payment flow
paymentRequest.on("paymentmethod", async ev=>{
  const amt = compute();
  status.textContent="";
  try{
    const r = await fetch("https://pay-charmers-v2.onrender.com/create-payment-intent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({amount:amt,currency:"usd"})
    });
    const data = await r.json();

    const confirm = await stripe.confirmCardPayment(
      data.clientSecret,
      {payment_method: ev.paymentMethod.id},
      {handleActions:false}
    );

    if(confirm.error){
      ev.complete("fail");
      status.textContent = confirm.error.message;
      status.style.color="#f87171";
      return;
    }

    ev.complete("success");
    finishEmail();
  }catch(e){
    ev.complete("fail");
    status.textContent="Payment failed.";
    status.style.color="#f87171";
  }
});

// Card button payment
paybtn.onclick = async()=>{
  if(paybtn.classList.contains("disabled")) return;

  const amt = compute();
  status.textContent="";
  try{
    const r = await fetch("https://pay-charmers-v2.onrender.com/create-payment-intent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({amount:amt,currency:"usd"})
    });
    const data = await r.json();

    const confirm = await stripe.confirmCardPayment(data.clientSecret,{
      payment_method:{
        card:card,
        billing_details:{ name:nameI.value, email:emailI.value }
      }
    });

    if(confirm.error){
      status.textContent=confirm.error.message;
      status.style.color="#f87171";
    } else {
      finishEmail();
    }
  }catch(e){
    status.textContent="Payment failed.";
    status.style.color="#f87171";
  }
};

// Email submit
function finishEmail(){
  status.style.color="#4ade80";
  status.textContent="Payment complete — opening email…";

  const body =
    "Name: "+nameI.value+
    "\nEmail: "+emailI.value+
    "\nPhone: "+phoneI.value+
    "\nBracelet: "+sBrace.textContent+
    "\nTax: "+sTax.textContent+
    "\nProcessing: "+sProc.textContent+
    "\nShipping: "+sShip.textContent+
    "\nTotal: "+sTotal.textContent+
    "\nBracelet size: "+size.options[size.selectedIndex].text+
    "\nBracelet color: "+color.value+
    "\nAddress: "+addr1.value+" "+addr2.value+", "+city.value+", "+state.value+" "+zip.value+", "+country.value;

  const mail="mailto:Charmers2346@gmail.com?subject="+
    encodeURIComponent("Charmers bracelet order")+
    "&body="+encodeURIComponent(body);

  window.location.href = mail;
}
</script>

</div></body></html>
