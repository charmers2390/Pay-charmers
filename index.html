<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Charmers Secure Checkout</title>
  <link rel="icon" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..." type="image/jpeg" />
  <style>
    body {
      background: linear-gradient(to right, purple, pink);
      font-family: Arial, sans-serif;
      color: white;
    }
    .form-container {
      background-color: #2d2d2d;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      border-radius: 10px;
    }
    .form-container input, .form-container select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: none;
      border-radius: 5px;
    }
    .form-container button {
      background-color: hotpink;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
    }
    .form-container button:hover {
      background-color: deeppink;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    .checkbox-group input {
      margin-right: 10px;
    }
    .footer {
      font-size: 12px;
      text-align: center;
      margin-top: 10px;
    }
    #payment-message {
      text-align: center;
      color: lightgreen;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.google.com/recaptcha/enterprise.js" async defer></script>
</head>
<body>
  <div class="form-container">
    <h2>Charmers Secure Checkout</h2>
    <div id="payment-request-button"></div>
    <form id="checkoutForm">
      <input type="text" name="name" placeholder="Name" required />
      <input type="email" name="email" placeholder="Email" required />
      <input type="tel" name="phone" placeholder="Phone Number (optional)" />
      <input type="text" name="bracelet" placeholder="Bracelet Text" required />
      <select name="shipping" required>
        <option value="">Select Shipping</option>
        <option value="9">Ground Advantage - $9</option>
        <option value="13">Priority Mail - $13</option>
        <option value="25">Priority Mail Express - $25</option>
        <option value="47">USPS First Class International - $47</option>
        <option value="78">USPS Priority Mail International - $78</option>
      </select>
      <select name="processing" required>
        <option value="0.5">Charmers 24 Hour Processing™ - $0.50</option>
        <option value="0">Charmers Seven Day 12 Hours Processing™ - $0.00</option>
      </select>
      <input name="street" type="text" placeholder="Street Address" required />
      <input name="street2" type="text" placeholder="Street Address 2 (optional)" />
      <input name="city" type="text" placeholder="City" required />
      <input name="state" type="text" placeholder="State/Territory (optional)" />
      <input name="postal" type="text" placeholder="Postal Code" required />
      <input name="country" type="text" placeholder="Country" required />

      <div id="card-element"></div>
      <div id="card-errors" role="alert" style="color: red;"></div>

      <div class="checkbox-group">
        <input type="checkbox" id="tos" required />
        <label for="tos">I agree to the <a href="https://tos.charmersbiz.org" target="_blank">ToS and usage policies</a></label>
      </div>
      <div class="g-recaptcha" data-sitekey="6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO" data-action="LOGIN"></div>
      <p id="total">Order Total: $0.00</p>
      <button id="submitBtn" type="submit">Complete Order</button>
      <p id="payment-message"></p>
    </form>
    <div class="footer">
      Powered by Stripe<br />
      For any refunds needed, <a href="https://refund.charmersbiz.org">click here</a>.
    </div>
  </div>
  <script>
    const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    function calculateTotal() {
      const text = document.querySelector("input[name='bracelet']").value.trim();
      const shipping = parseFloat(document.querySelector("select[name='shipping']").value || 0);
      const processing = parseFloat(document.querySelector("select[name='processing']").value || 0);
      let bracelet = 0;
      if (text.length > 100) return "BLOCKED";
      if (text.length > 30) bracelet = 15;
      else if (text.length > 12) bracelet = 10;
      else if (text.length >= 6) bracelet = 6;
      else if (text.length > 0) bracelet = 3;
      return (bracelet + shipping + processing).toFixed(2);
    }

    function validateFields() {
      const required = ['name', 'email', 'bracelet', 'shipping', 'processing'];
      return required.every(field => {
        const el = document.querySelector(`[name="${field}"]`);
        return el && el.value.trim() !== "";
      }) && calculateTotal() !== "BLOCKED";
    }

    function updateTotalDisplay() {
      const total = calculateTotal();
      document.getElementById("total").textContent = total === "BLOCKED"
        ? "Bracelet text too long (max 100 chars)"
        : "Order Total: $" + total;
    }

    const paymentRequest = stripe.paymentRequest({
      country: 'US',
      currency: 'usd',
      total: {
        label: 'Charmers Order',
        amount: 0,
      },
      requestPayerName: true,
      requestPayerEmail: true,
    });

    const prButton = elements.create("paymentRequestButton", {
      paymentRequest: paymentRequest,
    });

    function maybeShowPaymentRequestButton() {
      if (validateFields()) {
        const amount = parseFloat(calculateTotal()) * 100;
        paymentRequest.update({
          total: {
            label: "Charmers Order",
            amount: Math.round(amount)
          }
        });
        prButton.mount("#payment-request-button");
      } else {
        prButton.unmount();
      }
    }

    document.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("input", () => {
        updateTotalDisplay();
        maybeShowPaymentRequestButton();
      });
      el.addEventListener("change", () => {
        updateTotalDisplay();
        maybeShowPaymentRequestButton();
      });
    });

    paymentRequest.canMakePayment().then(result => {
      if (!result) {
        document.getElementById("payment-request-button").style.display = "none";
      }
    });

    card.on("change", function (event) {
      const displayError = document.getElementById("card-errors");
      displayError.textContent = event.error ? event.error.message : "";
    });

    document.getElementById("checkoutForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;

      const total = calculateTotal();
      if (total === "BLOCKED") {
        alert("Bracelet text too long. Max 100 characters.");
        btn.disabled = false;
        return;
      }

      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: "card",
        card: card,
        billing_details: {
          name: document.querySelector("input[name='name']").value,
          email: document.querySelector("input[name='email']").value,
        },
      });

      if (error) {
        document.getElementById("card-errors").textContent = error.message;
        btn.disabled = false;
      } else {
        document.getElementById("payment-message").textContent = "Order success, now press Complete Order again to email it!";
        btn.disabled = false;

        const mailBtn = document.createElement("button");
        mailBtn.textContent = "Send Order Details";
        mailBtn.style.marginTop = "10px";
        mailBtn.onclick = function () {
          const fields = [...document.querySelectorAll("form input, form select")];
          const body = fields.map(el =>
            el.name ? `${el.name.charAt(0).toUpperCase() + el.name.slice(1)}: ${el.value}` : ""
          ).join("%0D%0A");

          window.location.href = `mailto:support@charmersbiz.org?subject=New Charmers Order&body=${body}`;
        };
        document.querySelector(".form-container").appendChild(mailBtn);
      }
    });

    updateTotalDisplay();
  </script>
</body>
</html>
