<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charmers Checkout – FINAL PRODUCTION STRIPE (Apple Pay Enabled)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://js.stripe.com/v3/"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#7b16ff,#c822ff);
  margin:0;padding:20px;color:#fff;
}
.container{
  max-width:800px;margin:auto;
  background:rgba(255,255,255,0.16);
  padding:30px;border-radius:20px;
}
h2{text-align:center;font-size:32px;margin-bottom:25px;}
input,select{
  width:100%;padding:14px;margin-top:6px;
  border:none;border-radius:10px;
  background:#ffffffd9;font-size:15px;
}
button{
  width:100%;padding:16px;margin-top:25px;
  border:none;border-radius:12px;font-size:18px;
  background:#ff33dd;color:white;font-weight:bold;
}
button:disabled{background:#777;}
.total-box{
  background:rgba(0,0,0,0.25);
  padding:20px;border-radius:14px;margin-top:25px;
}
.row{display:flex;justify-content:space-between;margin:6px 0;}
.payment-panel{
  background:white;color:black;padding:20px;
  border-radius:16px;margin-top:25px;
}
</style>
</head>

<body>
<div class="container">
<h2>Charmers Checkout</h2>

<form id="checkoutForm">

<label>Full Name</label>
<input id="name" required>

<label>Email</label>
<input id="email" required type="email">

<label>Phone (optional)</label>
<input id="phone">

<label>Bracelet Size</label>
<select id="size" required>
<option value="">Select</option>
<option value="6">Extra Small – $6</option>
<option value="9">Small – $9</option>
<option value="11">Medium – $11</option>
<option value="15">Large – $15</option>
<option value="20">Extra Large – $20</option>
</select>

<label>Bracelet Color</label>
<input id="color" required>

<label>Shipping</label>
<select id="shipping" required>
<option value="9">Ground Advantage – $9</option>
<option value="13">Priority – $13</option>
<option value="25">Express – $25</option>
<option value="78">International – $78</option>
<option value="95">International Express – $95</option>
</select>

<label>Processing</label>
<select id="processing" required>
<option value="0">Charmers 24 Hour Processing – Free</option>
<option value="0.75">CLU Priority – $0.75</option>
<option value="1.00">CLU Express – $1.00</option>
</select>

<label>Street Address</label>
<input id="address1" required>

<label>Address Line 2 (optional)</label>
<input id="address2">

<label>City</label>
<input id="city" required>

<label>State</label>
<input id="region" required>

<label>Postal Code</label>
<input id="postal" required>

<div class="total-box">
  <div class="row"><span>Bracelet:</span><span id="braceCost">$0.00</span></div>
  <div class="row"><span>Shipping:</span><span id="shipCost">$0.00</span></div>
  <div class="row"><span>Processing:</span><span id="procCost">$0.00</span></div>
  <div class="row"><span>Fees:</span><span>$1.50</span></div>
  <div class="row"><span>Tax:</span><span id="taxCost">$0.00</span></div>
  <hr>
  <div class="row"><b>Total:</b><b id="total">$0.00</b></div>
</div>

<div class="payment-panel">
<h3>Payment</h3>
<div id="payment-request-button"></div>
<div id="card-element" style="margin-top:20px;"></div>
</div>

<button id="payBtn" disabled>Pay Now</button>

</form>
</div>

<script>
const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");

let clientSecret = null;

/* ---------- SETUP ELEMENTS ONCE ---------- */
let elements = stripe.elements();
let card = elements.create("payment");
card.mount("#card-element");

/* ---------- APPLE PAY / GOOGLE PAY ---------- */
let paymentRequest = stripe.paymentRequest({
  country: "US",
  currency: "usd",
  total: { label: "Charmers Order", amount: 100 },
  requestPayerName: true,
  requestPayerEmail: true
});

let prButton = elements.create("paymentRequestButton", {
  paymentRequest: paymentRequest
});

paymentRequest.canMakePayment().then(function(result){
  if(result){
    prButton.mount("#payment-request-button");
  }
});

/* ---------- TOTALS ---------- */
function calc(){
  let s = parseFloat(size.value||0);
  let sh = parseFloat(shipping.value||0);
  let p = parseFloat(processing.value||0);
  let fees = 1.50;

  let subtotal = s + sh + p + fees;
  let tax = subtotal * 0.095;
  let total = subtotal + tax;

  braceCost.textContent = "$" + s.toFixed(2);
  shipCost.textContent = "$" + sh.toFixed(2);
  procCost.textContent = "$" + p.toFixed(2);
  taxCost.textContent = "$" + tax.toFixed(2);
  totalEl.textContent = "$" + total.toFixed(2);

  return Math.round(total * 100);
}

/* ---------- UPDATE PAYMENT INTENT ONLY ---------- */
async function updateIntent(){
  const amount = calc();
  paymentRequest.update({ total: { label: "Charmers Order", amount } });

  const res = await fetch("https://pay-charmersv2.onrender.com/create-payment-intent",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({amount})
  });
  const data = await res.json();
  clientSecret = data.clientSecret;
}

document.querySelectorAll("input,select").forEach(el=>{
  el.addEventListener("input",()=>{
    calc();
    validate();
    updateIntent();
  });
});

/* ---------- FORM VALIDATION ---------- */
function validate(){
  const required = ["name","email","size","color","shipping","processing","address1","city","region","postal"];
  for(let id of required){
    if(!document.getElementById(id).value.trim()) return payBtn.disabled = true;
  }
  payBtn.disabled = false;
}

/* ---------- CONFIRM PAYMENT FIXED ---------- */
checkoutForm.addEventListener("submit", async e=>{
  e.preventDefault();

  const result = await stripe.confirmPayment({
    elements,
    clientSecret,
    confirmParams: {
      return_url: window.location.href,
      payment_method_data: {
        billing_details: {
          name: name.value,
          email: email.value,
          phone: phone.value || undefined
        }
      }
    },
    redirect: "if_required"
  });

  if(result.error){
    alert("Payment failed: " + result.error.message);
    return;
  }

  alert("Payment successful!");

  let body =
    "Name: "+name.value+"%0A"+
    "Email: "+email.value+"%0A"+
    "Bracelet Size: "+size.options[size.selectedIndex].text+"%0A"+
    "Bracelet Color: "+color.value+"%0A"+
    "Shipping: "+shipping.options[shipping.selectedIndex].text+"%0A"+
    "Processing: "+processing.options[processing.selectedIndex].text+"%0A"+
    "Address: "+address1.value+" "+address2.value+
      ", "+city.value+", "+region.value+" "+postal.value+"%0A"+
    "Total Paid: "+totalEl.textContent+"%0A"+
    "Payment ID: "+result.paymentIntent.id;

  window.location.href = "mailto:Charmers2346@gmail.com?subject=New+Charmers+Order&body="+body;
});

/* ---------- INITIAL ---------- */
calc();
updateIntent();
validate();

</script>

</body>
</html>
