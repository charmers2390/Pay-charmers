<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Charmers Checkout</title>
  <link rel="icon" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..." type="image/jpeg">
  <style>
    :root {
      --bg1: #6a0dad; /* purple */
      --bg2: #ff69b4; /* pink */
      --card: #1f1f1f;
      --text: #ffffff;
      --muted: #cfcfcf;
      --accent: #ff69b4;
      --accent-hover: #ff1493;
      --danger: #ff6b6b;
      --success: #90ee90;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .form-container {
      background: var(--card);
      width: 100%;
      max-width: 760px;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    h1, h2, h3 { margin: 0 0 12px; }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid-1 { grid-template-columns: 1fr; }
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #2a2a2a;
      color: var(--text);
      outline: none;
    }
    input::placeholder, textarea::placeholder { color: #9e9e9e; }
    .row { margin-bottom: 12px; }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    a { color: #ffd1e8; }
    #payment-request-wrap { margin: 10px 0 12px; display: none; }
    #payment-request-button { width: 100%; }
    .StripeElement, .stripe-hosted {
      background: #2a2a2a;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #333;
    }
    fieldset { border: 1px solid #333; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    legend { color: var(--muted); padding: 0 6px; }
    .pair { display:flex; gap:12px; }
    .pair > div { flex: 1; }
    .totals {
      background: #232323;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
      font-size: 14px;
      line-height: 1.5;
    }
    .totals .line { display: flex; justify-content: space-between; }
    .totals .grand { margin-top: 8px; font-weight: 700; font-size: 16px; }
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 14px;
      width: 100%;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s ease;
      margin-top: 10px;
    }
    .btn:hover { background: var(--accent-hover); }
    .btn[disabled] { opacity: .65; cursor: not-allowed; }
    #card-errors { color: var(--danger); min-height: 18px; margin-top: 6px; font-size: 13px; }
    #payment-message { text-align: center; font-weight: 700; margin-top: 10px; min-height: 20px; }
    #payment-message.success { color: var(--success); }
    #payment-message.fail { color: var(--danger); }
    .footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 14px; }
    #tooLong { color: var(--danger); display:none; margin-top:6px; }
    #recaptcha-container { margin-top: 8px; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .legal-guard { font-size: 12px; color: var(--muted); margin-top: 6px; }
  </style>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.google.com/recaptcha/enterprise.js?render=explicit"></script>
</head>
<body>
  <div class="form-container">
    <h2>Charmers Checkout</h2>
    <div class="subtitle">Secure payment powered by Stripe</div>

    <div id="payment-request-wrap"><div id="payment-request-button"></div></div>

    <form id="checkoutForm" class="grid grid-1" autocomplete="on">
      <div class="row">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" placeholder="Full name" required>
      </div>
      <div class="row">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>
      </div>
      <div class="row">
        <label for="phone">Phone (optional)</label>
        <input id="phone" name="phone" type="tel" placeholder="(optional)">
      </div>

      <fieldset>
        <legend>Bracelet Customization</legend>
        <div class="row">
          <label for="bracelet">Bracelet Text</label>
          <input id="bracelet" name="bracelet" type="text" placeholder="Your custom text" required>
          <div id="tooLong">Bracelet text too long (max 100 chars).</div>
        </div>

        <div class="pair">
          <div>
            <label for="size">Size</label>
            <select id="size" name="size" required>
              <option value="">Select size</option>
              <option value="S">Small</option>
              <option value="M">Medium</option>
              <option value="L">Large</option>
              <option value="XL">Extra Large</option>
            </select>
          </div>
          <div>
            <label for="type">Type</label>
            <select id="type" name="type" required>
              <option value="normal">Normal (Free)</option>
              <option value="complex">Complex (+$1)</option>
            </select>
          </div>
        </div>

        <div class="pair">
          <div>
            <label for="color1">Bracelet Color 1</label>
            <select id="color1" name="color1" required>
              <option value="">Select color</option>
              <option>cyan</option><option>orange</option><option>red</option><option>black</option>
              <option>blue</option><option>pink</option><option>purple</option><option>yellow</option>
              <option>green</option><option>cyan mix</option><option>dark green</option><option>light green</option>
              <option>light yellow</option><option>dark purple</option>
            </select>
          </div>
          <div>
            <label for="color2">Bracelet Color 2 (optional)</label>
            <select id="color2" name="color2">
              <option value="">(none)</option>
              <option>cyan</option><option>orange</option><option>red</option><option>black</option>
              <option>blue</option><option>pink</option><option>purple</option><option>yellow</option>
              <option>green</option><option>cyan mix</option><option>dark green</option><option>light green</option>
              <option>light yellow</option><option>dark purple</option>
            </select>
          </div>
        </div>

        <div class="pair">
          <div>
            <label for="beads">Beads</label>
            <select id="beads" name="beads">
              <option value="">(none)</option>
              <option value="circle">Circle</option>
              <option value="rectangle">Rectangle</option>
              <option value="letters">Letters</option>
            </select>
          </div>
          <div id="lettersWrap" style="display:none;">
            <label for="lettersText">Letters (if chosen)</label>
            <input id="lettersText" name="lettersText" type="text" placeholder="What should the letters say?">
          </div>
        </div>

        <div class="row">
          <label for="style">Preset Styles (disables size)</label>
          <select id="style" name="style">
            <option value="">(none)</option>
            <option value="fire_ice" data-price="6">Fire and ice — $6</option>
            <option value="charmers_trio" data-price="10">Charmers, trio — $10</option>
            <option value="pink_navy" data-price="5">Pink and navy — $5</option>
          </select>
          <div class="hint">If a style is selected, the bracelet price is based on the style and size is not used.</div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Shipping</legend>
        <div class="pair">
          <div>
            <label for="shipping">Shipping</label>
            <select id="shipping" name="shipping" required>
              <option value="">Select Shipping</option>
              <option value="9">Ground Advantage - $9</option>
              <option value="13">Priority Mail - $13</option>
              <option value="25">Priority Mail Express - $25</option>
              <option value="47">USPS First Class International - $47</option>
              <option value="78">USPS Priority Mail International - $78</option>
            </select>
          </div>
          <div>
            <label for="processing">Processing</label>
            <select id="processing" name="processing" required>
              <option value="0.50">Charmers 24 Hour Processing™ - $0.50</option>
              <option value="0">Charmers Seven Day 12 Hours Processing™ - $0.00</option>
            </select>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Address</legend>
        <div class="row">
          <label for="street">Street Address</label>
          <input id="street" name="street" type="text" placeholder="Street address" required>
        </div>
        <div class="row">
          <label for="street2">Street Address 2 (optional)</label>
          <input id="street2" name="street2" type="text" placeholder="Apt, suite, etc. (optional)">
        </div>
        <div class="pair">
          <div>
            <label for="city">City</label>
            <input id="city" name="city" type="text" required>
          </div>
          <div>
            <label for="state">State/Territory (optional)</label>
            <input id="state" name="state" type="text">
          </div>
        </div>
        <div class="pair">
          <div>
            <label for="postal">Postal Code</label>
            <input id="postal" name="postal" type="text" required>
          </div>
          <div>
            <label for="country">Country</label>
            <input id="country" name="country" type="text" required>
          </div>
        </div>
      </fieldset>

      <div class="row">
        <label>Card</label>
        <div id="card-element" class="stripe-hosted"></div>
        <div id="card-errors" role="alert"></div>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="tos" required>
        <label for="tos">I agree to the <a href="https://tos.charmersbiz.org/" target="_blank" rel="noopener">ToS and usage policies</a></label>
      </div>

      <div id="recaptcha-container"></div>
      <div class="legal-guard">Please complete the security check to continue.</div>
      <input type="hidden" id="recaptcha_token" name="recaptcha_token" />

      <div class="totals" id="totalsBox">
        <div class="line"><span>Bracelet/Style</span><span id="priceBracelet">$0.00</span></div>
        <div class="line"><span>Type</span><span id="priceType">$0.00</span></div>
        <div class="line"><span>Shipping</span><span id="priceShipping">$0.00</span></div>
        <div class="line"><span>Processing</span><span id="priceProcessing">$0.00</span></div>
        <div class="grand"><span>Total</span> <span id="priceTotal">$0.00</span></div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Complete Payment</button>
      <button id="emailBtn" class="btn" type="button" style="display:none;">Submit Order (Email Receipt)</button>
      <div class="hint" id="emailHint" style="display:none;">This will open your email app with your order details.</div>

      <div id="payment-message"></div>
    </form>

    <div class="footer">
      Powered by Stripe • For refunds, <a href="https://refund.charmersbiz.org/" target="_blank" rel="noopener">click here</a>.
    </div>
  </div>

  <script>
    const STRIPE_PK = "pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc";
    const RECAPTCHA_SITE_KEY = "6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO";
    const BACKEND_BASE = "https://charmerspay.onrender.com";

    const stripe = Stripe(STRIPE_PK);
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    const form = document.getElementById("checkoutForm");
    const submitBtn = document.getElementById("submitBtn");
    const emailBtn = document.getElementById("emailBtn");
    const emailHint = document.getElementById("emailHint");
    const msg = document.getElementById("payment-message");
    const errorBox = document.getElementById("card-errors");
    const prWrap = document.getElementById("payment-request-wrap");

    let pr, prButton, prSupported = false, prCapabilities = null;
    let recaptchaWidgetId = null;
    let lastPaymentIntentId = null;

    function friendlyError(code, fallback) {
      const map = {
        "card_declined": "The card was declined by your bank, try again later.",
        "incorrect_number": "Check the card number.",
        "expired_card": "Your card has expired.",
        "processing_error": "There was a processing error. Please try again.",
        "insufficient_funds": "The card has insufficient funds.",
      };
      return map[code] || (fallback || "Something went wrong. Please try again.");
    }
    function currency(n) { return `$${(Math.round(Number(n) * 100) / 100).toFixed(2)}`; }
    function getFields() { const d = {}; new FormData(form).forEach((v,k)=>d[k]=v); return d; }
    function isBlocked(text) { return text && text.trim().length > 100; }

    // ===== Pricing =====
    function computeBraceletPrice() {
      const f = getFields();
      const text = (f.bracelet || "").trim();
      if (isBlocked(text)) return { price: 0, blocked: true };

      const styleSel = document.getElementById("style");
      const styleOption = styleSel.options[styleSel.selectedIndex];
      const stylePrice = Number(styleOption?.dataset?.price || 0);
      if (styleSel.value) return { price: stylePrice, blocked: false, used: "style" };

      const size = f.size || "";
      if (!size) return { price: 0, blocked: false, used: "size" };

      const twoColors = (f.color2 || "").trim() !== "";
      const beads = (f.beads || "").trim() !== "";
      const premiumMode = twoColors || beads;

      const singleTier = { "S": 3, "M": 5, "L": 7, "XL": 10 };
      const premiumTier = { "S": 5, "M": 6, "L": 8, "XL": 11 };
      const table = premiumMode ? premiumTier : singleTier;
      const price = table[size] || 0;
      return { price, blocked: false, used: "size" };
    }
    function computeTypePrice() { const f = getFields(); return f.type === "complex" ? 1 : 0; }
    function calcPricing() {
      const f = getFields();
      const shipping = parseFloat(f.shipping || 0);
      const processing = parseFloat(f.processing || 0);
      const braceletInfo = computeBraceletPrice();
      const typePrice = computeTypePrice();
      const total = braceletInfo.blocked ? 0 : (braceletInfo.price + typePrice + shipping + processing);
      return { braceletInfo, shipping, processing, typePrice, total, blocked: braceletInfo.blocked };
    }

    function updateTotalsUI() {
      const p = calcPricing();
      document.getElementById("priceBracelet").textContent = currency(p.braceletInfo.price);
      document.getElementById("priceType").textContent = currency(p.typePrice);
      document.getElementById("priceShipping").textContent = currency(p.shipping);
      document.getElementById("priceProcessing").textContent = currency(p.processing);
      document.getElementById("priceTotal").textContent = currency(p.total);
      document.getElementById("tooLong").style.display = p.blocked ? "block" : "none";
      if (prSupported && !p.blocked && legalOk() && validForWallet()) {
        pr.update({ total: { label: "Charmers Order", amount: Math.round(p.total * 100) } });
      }
      togglePRB();
      document.getElementById("size").disabled = !!document.getElementById("style").value;
    }

    // ===== Legal enforcement (ToS + reCAPTCHA) =====
    function currentRecaptchaResponse() {
      try {
        if (window.grecaptcha && grecaptcha.enterprise && recaptchaWidgetId !== null) {
          return grecaptcha.enterprise.getResponse(recaptchaWidgetId) || "";
        }
      } catch {}
      return "";
    }
    function legalOk() {
      const tosOk = document.getElementById("tos").checked;
      const recOk = !!currentRecaptchaResponse();
      return tosOk && recOk;
    }

    function validForWallet() {
      const f = getFields();
      const required = ["name","email","bracelet","shipping","processing"];
      const filled = required.every(k => (f[k] || "").toString().trim() !== "");
      return filled && !calcPricing().blocked;
    }

    function togglePRB() {
      if (prSupported && validForWallet() && legalOk()) prWrap.style.display = "block";
      else prWrap.style.display = "none";
    }

    // ===== reCAPTCHA =====
    function initRecaptcha() {
      if (!window.grecaptcha || !grecaptcha.enterprise) return;
      try {
        recaptchaWidgetId = grecaptcha.enterprise.render("recaptcha-container", { sitekey: RECAPTCHA_SITE_KEY });
      } catch (e) {}
    }

    // ===== Payment Request (Wallets) =====
    function initPaymentRequest() {
      pr = stripe.paymentRequest({
        country: "US",
        currency: "usd",
        total: { label: "Charmers Order", amount: Math.round(calcPricing().total * 100) },
        requestPayerName: true,
        requestPayerEmail: true
      });
      pr.canMakePayment().then(result => {
        if (result) {
          prSupported = true;
          prCapabilities = result;
          const elementsLocal = stripe.elements();
          prButton = elementsLocal.create("paymentRequestButton", { paymentRequest: pr });
          prButton.mount("#payment-request-button");
          togglePRB();
        } else {
          prSupported = false;
          prWrap.style.display = "none";
        }
      });

      pr.on("paymentmethod", async (ev) => {
        if (!legalOk()) {
          ev.complete("fail");
          setMessage("fail", "Please agree to the ToS and complete the security check.");
          return;
        }

        const walletType = (window.ApplePaySession && prCapabilities && prCapabilities.applePay) ? "apple" :
                           (prCapabilities && prCapabilities.googlePay) ? "google" : "wallet";
        try {
          submitBtn.disabled = true;
          setMessage("", "");

          const pricing = calcPricing();
          if (pricing.blocked || pricing.total <= 0) {
            ev.complete("fail");
            setMessage("fail", "Your payment failed.");
            submitBtn.disabled = false;
            return;
          }

          const recaptchaToken = currentRecaptchaResponse();
          if (!recaptchaToken) {
            ev.complete("fail");
            setMessage("fail", "Please complete the security check.");
            submitBtn.disabled = false;
            return;
          }

          const piRes = await fetch(`https://charmerspay.onrender.com/create-payment-intent`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amount: Math.round(pricing.total * 100),
              currency: "usd",
              recaptcha_token: recaptchaToken,
              metadata: buildMetadata()
            })
          });
          const piData = await piRes.json();
          if (!piRes.ok) throw new Error(piData?.error || "Backend error creating PaymentIntent");
          if (!piData || !piData.client_secret) throw new Error("Missing client_secret");

          const confirm = await stripe.confirmCardPayment(piData.client_secret, {
            payment_method: ev.paymentMethod.id
          }, { handleActions: false });

          if (confirm.error) {
            ev.complete("fail");
            setWalletFailMessage(walletType, confirm.error);
            submitBtn.disabled = false;
            return;
          } else {
            ev.complete("success");
          }

          let intent = confirm.paymentIntent;
          if (intent && intent.status === "requires_action") {
            const next = await stripe.confirmCardPayment(piData.client_secret);
            if (next.error) {
              setWalletFailMessage(walletType, next.error);
              submitBtn.disabled = false;
              return;
            }
            intent = next.paymentIntent;
          }

          lastPaymentIntentId = intent && intent.id;
          await sendOrderToBackend(lastPaymentIntentId, walletType);
          setWalletSuccessMessage(walletType);
          revealEmailButton();
          submitBtn.disabled = false;
        } catch (err) {
          console.error(err);
          ev.complete && ev.complete("fail");
          setMessage("fail", "Your payment failed.");
          submitBtn.disabled = false;
        }
      });
    }

    // ===== Metadata + messaging =====
    function buildMetadata() {
      const f = getFields();
      const p = calcPricing();
      return {
        name: f.name || "",
        email: f.email || "",
        phone: f.phone || "",
        bracelet: f.bracelet || "",
        size: f.size || "",
        type: f.type || "",
        color1: f.color1 || "",
        color2: f.color2 || "",
        beads: f.beads || "",
        letters: f.lettersText || "",
        style: f.style || "",
        shipping: f.shipping || "",
        processing: f.processing || "",
        street: f.street || "",
        street2: f.street2 || "",
        city: f.city || "",
        state: f.state || "",
        postal: f.postal || "",
        country: f.country || "",
        total_display: currency(p.total)
      };
    }

    function setMessage(kind, text) {
      msg.classList.remove("success","fail");
      if (!text) { msg.textContent = ""; return; }
      msg.classList.add(kind === "success" ? "success" : "fail");
      msg.textContent = text;
    }
    function setWalletSuccessMessage(walletType) {
      const specific = walletType === "apple"
        ? "Payment processed. Confirmation email coming soon."
        : walletType === "google"
          ? "Confirmation email sent."
          : "Payment processed.";
      const unified = "Your order was processed. Expect a confirmation email from Charmers soon.";
      setMessage("success", `${specific} ${unified}`);
    }
    function setWalletFailMessage(walletType, err) {
      const specific = walletType === "apple"
        ? "Payment failed. Try card number payment."
        : walletType === "google"
          ? "Payment failed. Try card number."
          : friendlyError(err && err.code, "Your payment failed.");
      const unified = "Your payment failed.";
      setMessage("fail", `${specific} ${unified}`);
    }

    async function sendOrderToBackend(payment_intent_id, methodUsed) {
      const f = getFields();
      const p = calcPricing();
      try {
        await fetch(`${BACKEND_BASE}/save-order`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            payment_intent_id,
            method: methodUsed || "card",
            total_cents: Math.round(p.total * 100),
            order: { ...f, total_display: currency(p.total) }
          })
        });
      } catch (e) {
        console.warn("Order save failed (non-blocking)", e);
      }
    }

    // ===== Email "Submit Order" after payment success =====
    function revealEmailButton() {
      emailBtn.style.display = "block";
      emailHint.style.display = "block";
    }

    function buildEmailBody() {
      const f = getFields();
      const p = calcPricing();
      const lines = [
        "Thanks for your purchase from Charmers!",
        "",
        "Order Details:",
        `Name: ${f.name || ""}`,
        `Email: ${f.email || ""}`,
        `Phone: ${f.phone || ""}`,
        `Bracelet Text: ${f.bracelet || ""}`,
        `Size: ${f.style ? "(preset style selected — size not used)" : (f.size || "")}`,
        `Type: ${f.type || ""}`,
        `Color 1: ${f.color1 || ""}`,
        `Color 2: ${f.color2 || "(none)"}`,
        `Beads: ${f.beads || "(none)"}`,
        f.beads === "letters" ? `Letters: ${f.lettersText || ""}` : null,
        `Preset Style: ${f.style || "(none)"}`,
        "",
        "Shipping Address:",
        (f.street || ""),
        (f.street2 || ""),
        `${f.city || ""}, ${f.state || ""} ${f.postal || ""}`,
        (f.country || ""),
        "",
        "Pricing:",
        `Bracelet/Style: ${document.getElementById("priceBracelet").textContent}`,
        `Type: ${document.getElementById("priceType").textContent}`,
        `Shipping: ${document.getElementById("priceShipping").textContent}`,
        `Processing: ${document.getElementById("priceProcessing").textContent}`,
        `TOTAL: ${document.getElementById("priceTotal").textContent}`,
        lastPaymentIntentId ? `Payment Intent: ${lastPaymentIntentId}` : null
      ].filter(Boolean);
      return lines.join("\\r\\n");
    }

    emailBtn.addEventListener("click", () => {
      const f = getFields();
      const to = (f.email || "").trim();
      if (!to) { alert("Missing email address."); return; }
      const subject = encodeURIComponent("Charmers Order Confirmation");
      const body = encodeURIComponent(buildEmailBody());
      window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
    });

    // ===== Card element errors =====
    card.on("change", function (event) {
      errorBox.textContent = event.error ? friendlyError(event.error.code, event.error.message) : "";
    });

    // ===== Card submit (enforces ToS + checkbox reCAPTCHA) =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage("", ""); errorBox.textContent = "";

      if (!document.getElementById("tos").checked) { setMessage("fail", "Please agree to the ToS to continue."); return; }

      const recaptchaToken = currentRecaptchaResponse();
      if (!recaptchaToken) { setMessage("fail", "Please complete the security check."); return; }

      const f = getFields();
      if (isBlocked(f.bracelet || "")) { setMessage("fail", "Bracelet text too long (max 100 chars)."); return; }

      const p = calcPricing();
      if (p.total <= 0) { setMessage("fail", "Please complete all required fields."); return; }

      try {
        submitBtn.disabled = true;

        const res = await fetch(`${BACKEND_BASE}/create-payment-intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: Math.round(p.total * 100),
            currency: "usd",
            recaptcha_token: recaptchaToken,
            metadata: buildMetadata()
          })
        });
        const data = await res.json();
        if (!res.ok) { setMessage("fail", data?.error || "Backend error creating PaymentIntent."); submitBtn.disabled = false; return; }
        if (!data || !data.client_secret) throw new Error("Missing client_secret");

        const confirm = await stripe.confirmCardPayment(data.client_secret, {
          payment_method: {
            card,
            billing_details: {
              name: document.getElementById("name").value,
              email: document.getElementById("email").value,
            }
          }
        });

        if (confirm.error) {
          errorBox.textContent = friendlyError(confirm.error.code, confirm.error.message);
          setMessage("fail", "Your transaction was failed. Try again later.");
          submitBtn.disabled = false;
          return;
        }

        if (confirm.paymentIntent && confirm.paymentIntent.status === "succeeded") {
          lastPaymentIntentId = confirm.paymentIntent.id;
          await sendOrderToBackend(lastPaymentIntentId, "card");
          setMessage("success", "Payment processed! Click “Submit Order (Email Receipt)” to email a copy to yourself.");
          revealEmailButton();
        } else {
          setMessage("fail", "Your payment failed.");
        }
      } catch (err) {
        console.error(err);
        setMessage("fail", "Your payment failed.");
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ===== Dynamic UI bindings =====
    Array.from(form.querySelectorAll("input, select, textarea")).forEach(el => {
      el.addEventListener("input", () => { updateTotalsUI(); togglePRB(); });
      el.addEventListener("change", () => { updateTotalsUI(); togglePRB(); });
    });

    document.getElementById("beads").addEventListener("change", () => {
      const v = document.getElementById("beads").value;
      document.getElementById("lettersWrap").style.display = (v === "letters") ? "block" : "none";
    });

    // Init
    updateTotalsUI();
    initPaymentRequest();

    if (window.grecaptcha) {
      grecaptcha.enterprise.ready(initRecaptcha);
    } else {
      window.addEventListener("load", () => {
        if (window.grecaptcha) grecaptcha.enterprise.ready(initRecaptcha);
      });
    }
  </script>
</body>
</html>
